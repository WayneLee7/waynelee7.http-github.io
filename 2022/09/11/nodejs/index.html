<!DOCTYPE html>
<html lang="zh-Hans">
<head>
  <meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=2">
<meta name="theme-color" content="#222">
<meta name="generator" content="Hexo 3.9.0">
  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png">
  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png">
  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png">
  <link rel="mask-icon" href="/images/logo.svg" color="#222">
  <link rel="alternate" href="/atom.xml" title="李凤伟的小站" type="application/atom+xml">

<link rel="stylesheet" href="/css/main.css">


<link rel="stylesheet" href="/lib/font-awesome/css/font-awesome.min.css">


<script id="hexo-configurations">
  var NexT = window.NexT || {};
  var CONFIG = {
    root: '/',
    scheme: 'Pisces',
    version: '7.5.0',
    exturl: false,
    sidebar: {"position":"left","display":"always","offset":12,"onmobile":false},
    copycode: {"enable":true,"show_result":false,"style":null},
    back2top: {"enable":true,"sidebar":false,"scrollpercent":true},
    bookmark: {"enable":false,"color":"#222","save":"auto"},
    fancybox: false,
    mediumzoom: false,
    lazyload: false,
    pangu: false,
    algolia: {
      appID: '',
      apiKey: '',
      indexName: '',
      hits: {"per_page":10},
      labels: {"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}
    },
    localsearch: {"enable":false,"trigger":"auto","top_n_per_article":1,"unescape":false,"preload":false},
    path: 'search.xml',
    motion: {"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}},
    translation: {
      copy_button: '复制',
      copy_success: '复制成功',
      copy_failure: '复制失败'
    },
    sidebarPadding: 40
  };
</script>
<script src="//cdn.bootcss.com/pace/1.0.2/pace.min.js"></script>
<link href="//cdn.bootcss.com/pace/1.0.2/themes/pink/pace-theme-flash.css" rel="stylesheet">
<style>
    .pace .pace-progress {
        background: #1E92FB; /*进度条颜色*/
        height: 3px;
    }
    .pace .pace-progress-inner {
         box-shadow: 0 0 10px #1E92FB, 0 0 5px     #1E92FB; /*阴影颜色*/
    }
    .pace .pace-activity {
        border-top-color: #1E92FB;    /*上边框颜色*/
        border-left-color: #1E92FB;    /*左边框颜色*/
    }
</style>

  <meta name="description" content="Nodejs复习手册初识 Nodejs Node.js® is a JavaScript runtime built on Chrome’s V8 JavaScript engine Node.js® 是一个基于 Chrome V8 引擎 的 JavaScript 运行时环境  基于 Express 框架 (opens new window)，可以快速构建 Web 应用 基于 Electron 框">
<meta property="og:type" content="article">
<meta property="og:title" content="nodejs">
<meta property="og:url" content="http://yoursite.com/2022/09/11/nodejs/index.html">
<meta property="og:site_name" content="李凤伟的小站">
<meta property="og:description" content="Nodejs复习手册初识 Nodejs Node.js® is a JavaScript runtime built on Chrome’s V8 JavaScript engine Node.js® 是一个基于 Chrome V8 引擎 的 JavaScript 运行时环境  基于 Express 框架 (opens new window)，可以快速构建 Web 应用 基于 Electron 框">
<meta property="og:locale" content="zh-Hans">
<meta property="og:image" content="https://brucecai55520.gitee.io/bruceblog/assets/img/Session.c66d5499.png">
<meta property="og:image" content="https://brucecai55520.gitee.io/bruceblog/assets/img/JWT.6a82c41d.png">
<meta property="og:image" content="https://brucecai55520.gitee.io/bruceblog/assets/img/ev_users.77f8cdd3.png">
<meta property="og:image" content="https://brucecai55520.gitee.io/bruceblog/assets/img/ev_article_cate.f52fe7ce.png">
<meta property="og:image" content="https://brucecai55520.gitee.io/bruceblog/assets/img/ev_articles.01220b03.png">
<meta property="og:updated_time" content="2022-09-11T15:25:59.973Z">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="nodejs">
<meta name="twitter:description" content="Nodejs复习手册初识 Nodejs Node.js® is a JavaScript runtime built on Chrome’s V8 JavaScript engine Node.js® 是一个基于 Chrome V8 引擎 的 JavaScript 运行时环境  基于 Express 框架 (opens new window)，可以快速构建 Web 应用 基于 Electron 框">
<meta name="twitter:image" content="https://brucecai55520.gitee.io/bruceblog/assets/img/Session.c66d5499.png">

<link rel="canonical" href="http://yoursite.com/2022/09/11/nodejs/">


<script id="page-configurations">
  // https://hexo.io/docs/variables.html
  CONFIG.page = {
    sidebar: "",
    isHome: false,
    isPost: true,
    isPage: false,
    isArchive: false
  };
</script>

  <title>nodejs | 李凤伟的小站</title>
  






  <noscript>
  <style>
  .use-motion .brand,
  .use-motion .menu-item,
  .sidebar-inner,
  .use-motion .post-block,
  .use-motion .pagination,
  .use-motion .comments,
  .use-motion .post-header,
  .use-motion .post-body,
  .use-motion .collection-header { opacity: initial; }

  .use-motion .site-title,
  .use-motion .site-subtitle {
    opacity: initial;
    top: initial;
  }

  .use-motion .logo-line-before i { left: initial; }
  .use-motion .logo-line-after i { right: initial; }
  </style>
</noscript>


  <!-- 爆炸红心效果 -->
<canvas class="fireworks" style="position: fixed;left: 0;top: 0;z-index: 1; pointer-events: none;" ></canvas> 
<script type="text/javascript" src="//cdn.bootcss.com/animejs/2.2.0/anime.min.js"></script> 
<script type="text/javascript" src="/js/firework.js"></script>
<!-- 添加动态线条背景 -->

<script type="text/javascript" color="0,0,0" opacity='1.0'  src="//cdn.bootcss.com/canvas-nest.js/1.0.0/canvas-nest.min.js"></script>


</head>

<body itemscope itemtype="http://schema.org/WebPage">
  <div class="container use-motion">
    <div class="headband"></div>
   <a href="https://your-url" class="github-corner" aria-label="View source on GitHub"><svg width="80" height="80" viewBox="0 0 250 250" style="fill:#151513; color:#fff; position: absolute; top: 0; border: 0; right: 0;" aria-hidden="true"><path d="M0,0 L115,115 L130,115 L142,142 L250,250 L250,0 Z"></path><path d="M128.3,109.0 C113.8,99.7 119.0,89.6 119.0,89.6 C122.0,82.7 120.5,78.6 120.5,78.6 C119.2,72.0 123.4,76.3 123.4,76.3 C127.3,80.9 125.5,87.3 125.5,87.3 C122.9,97.6 130.6,101.9 134.4,103.2" fill="currentColor" style="transform-origin: 130px 106px;" class="octo-arm"></path><path d="M115.0,115.0 C114.9,115.1 118.7,116.5 119.8,115.4 L133.7,101.6 C136.9,99.2 139.9,98.4 142.2,98.6 C133.8,88.0 127.5,74.4 143.8,58.0 C148.5,53.4 154.0,51.2 159.7,51.0 C160.3,49.4 163.2,43.6 171.4,40.1 C171.4,40.1 176.1,42.5 178.8,56.2 C183.1,58.6 187.2,61.8 190.9,65.4 C194.5,69.0 197.7,73.2 200.1,77.6 C213.8,80.2 216.3,84.9 216.3,84.9 C212.7,93.1 206.9,96.0 205.4,96.6 C205.1,102.4 203.0,107.8 198.3,112.5 C181.9,128.9 168.3,122.5 157.7,114.1 C157.9,116.9 156.7,120.9 152.7,124.9 L141.0,136.5 C139.8,137.7 141.6,141.9 141.8,141.8 Z" fill="currentColor" class="octo-body"></path></svg></a><style>.github-corner:hover .octo-arm{animation:octocat-wave 560ms ease-in-out}@keyframes octocat-wave{0%,100%{transform:rotate(0)}20%,60%{transform:rotate(-25deg)}40%,80%{transform:rotate(10deg)}}@media (max-width:500px){.github-corner:hover .octo-arm{animation:none}.github-corner .octo-arm{animation:octocat-wave 560ms ease-in-out}}</style>

    <header class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-container">
  <div class="site-meta">

    <div>
      <a href="/" class="brand" rel="start">
        <span class="logo-line-before"><i></i></span>
        <span class="site-title">李凤伟的小站</span>
        <span class="logo-line-after"><i></i></span>
      </a>
    </div>
  </div>

  <div class="site-nav-toggle">
    <div class="toggle" aria-label="切换导航栏">
      <span class="toggle-line toggle-line-first"></span>
      <span class="toggle-line toggle-line-middle"></span>
      <span class="toggle-line toggle-line-last"></span>
    </div>
  </div>
</div>


<nav class="site-nav">
  
  <ul id="menu" class="menu">
        <li class="menu-item menu-item-home">

    <a href="/" rel="section"><i class="fa fa-fw fa-home"></i>首页</a>

  </li>
        <li class="menu-item menu-item-about">

    <a href="/about/" rel="section"><i class="fa fa-fw fa-user"></i>关于</a>

  </li>
        <li class="menu-item menu-item-tags">

    <a href="/tags/" rel="section"><i class="fa fa-fw fa-tags"></i>标签</a>

  </li>
        <li class="menu-item menu-item-categories">

    <a href="/categories/" rel="section"><i class="fa fa-fw fa-th"></i>分类</a>

  </li>
  </ul>

</nav>
</div>
    </header>

    
  <div class="back-to-top">
    <i class="fa fa-arrow-up"></i>
    <span>0%</span>
  </div>


    <main class="main">
      <div class="main-inner">
        <div class="content-wrap">
          

          <div class="content">
            

  <div class="posts-expand">
      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block " lang="zh-Hans">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2022/09/11/nodejs/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="WayneLee">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="李凤伟的小站">
    </span>
      <header class="post-header">
        <h1 class="post-title" itemprop="name headline">
          nodejs
        </h1>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>
              

              <time title="创建时间：2022-09-11 23:11:59 / 修改时间：23:25:59" itemprop="dateCreated datePublished" datetime="2022-09-11T23:11:59+08:00">2022-09-11</time>
            </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              <span class="post-meta-item-text">分类于</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/nodejs/" itemprop="url" rel="index">
                    <span itemprop="name">nodejs</span>
                  </a>
                </span>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
        <h2 id="Nodejs复习手册"><a href="#Nodejs复习手册" class="headerlink" title="Nodejs复习手册"></a>Nodejs复习手册</h2><h3 id="初识-Nodejs"><a href="#初识-Nodejs" class="headerlink" title="初识 Nodejs"></a>初识 Nodejs</h3><blockquote>
<p>Node.js® is a JavaScript runtime built on Chrome’s V8 JavaScript engine</p>
<p>Node.js® 是一个基于 Chrome V8 引擎 的 JavaScript 运行时环境</p>
</blockquote><ul>
<li>基于 <a href="http://www.expressjs.com.cn/" target="_blank" rel="noopener">Express 框架 (opens new window)</a>，可以快速构建 Web 应用</li>
<li>基于 <a href="https://electronjs.org/" target="_blank" rel="noopener">Electron 框架 (opens new window)</a>，可以构建跨平台的桌面应用</li>
<li>基于 <a href="http://restify.com/" target="_blank" rel="noopener">restify 框架 (opens new window)</a>，可以快速构建 API 接口项目</li>
<li>读写和操作数据库、创建实用的命令行工具辅助前端开发、etc…</li>
</ul><a id="more"></a>

<h2 id="fs文件系统模块"><a href="#fs文件系统模块" class="headerlink" title="fs文件系统模块"></a>fs文件系统模块</h2><ul>
<li>fs 模块中所有的操作都有两种形式可供选择:同步和异步</li>
<li>同步文件系统会阻塞程序的执行，也就是除非操作完毕，否则不会向下执行代码</li>
<li>异步文件系统不会阻塞程序的执行，而是在操作完成时，通过回调函数将结果返回</li>
<li><p>实际开发很少用同步方式，因此只介绍异步方式</p>
<p>打开模式： </p>
</li>
</ul>
<table>
<thead>
<tr>
<th>模式</th>
<th>说明</th>
</tr>
</thead>
<tbody>
<tr>
<td>r</td>
<td>读取文件，文件不存在抛异常</td>
</tr>
<tr>
<td>r+</td>
<td>读写文件，文件不存在抛异常</td>
</tr>
<tr>
<td>rs</td>
<td>同步模式下打开文件用于读取</td>
</tr>
<tr>
<td>rs+</td>
<td>同步模式下打开文件用于读写</td>
</tr>
<tr>
<td>w</td>
<td>写文件，不存在则创建，存在则覆盖原有内容</td>
</tr>
<tr>
<td>wx</td>
<td>写文件，文件存在打开失败</td>
</tr>
<tr>
<td>w+</td>
<td>读写文件，不存在创建，存在截断</td>
</tr>
<tr>
<td>wx+</td>
<td>读写，存在打开失败</td>
</tr>
<tr>
<td>a</td>
<td>追加，不存在创建</td>
</tr>
<tr>
<td>ax</td>
<td>追加，存在失败</td>
</tr>
<tr>
<td>a+</td>
<td>追加和读取，不存在创建</td>
</tr>
<tr>
<td>ax+</td>
<td>追加和读取，存在失败</td>
</tr>
</tbody>
</table>
<p><strong>读取文件</strong></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">fs.readFile(path,[options],callback)</span><br></pre></td></tr></table></figure>
<p>path:文件路径</p>
<p>options：配置选项，若是字符串则指定编码格式                   encoding：编码格式</p>
<p>​            flag：打开方式    </p>
<p>callbakc：回调函数</p>
<p>​            err：错误信息    </p>
<p>​            data：读取的数据，如果未指定编码格式则返回一个Buffer</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> fs = <span class="built_in">require</span>(<span class="string">'fs'</span>)</span><br><span class="line"></span><br><span class="line">fs.readFile(<span class="string">'./files/1.txt'</span>, <span class="string">'utf-8'</span>, <span class="function"><span class="keyword">function</span>(<span class="params">err, data</span>) =&gt; </span>&#123;</span><br><span class="line">  <span class="keyword">if</span>(err) &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="built_in">console</span>.log(<span class="string">'failed!'</span> + err.message)</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="built_in">console</span>.log(<span class="string">'content:'</span> + data)</span><br><span class="line">&#125;)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">// 复制文件内容</span></span><br><span class="line">fs.readFile(<span class="string">"C:/Users/笔记.mp3"</span>, <span class="function"><span class="keyword">function</span>(<span class="params">err, data</span>) </span>&#123;</span><br><span class="line">	<span class="keyword">if</span>(!err) &#123;</span><br><span class="line">		<span class="built_in">console</span>.log(data);</span><br><span class="line">		<span class="comment">// 将data写入到文件中</span></span><br><span class="line">		fs.writeFile(<span class="string">"C:/Users/hello.jpg"</span>, data, <span class="function"><span class="keyword">function</span>(<span class="params">err</span>)</span>&#123;</span><br><span class="line">			<span class="keyword">if</span>(!err)&#123;</span><br><span class="line">				<span class="built_in">console</span>.log(<span class="string">"文件写入成功"</span>);</span><br><span class="line">			&#125;</span><br><span class="line">		&#125; );</span><br><span class="line">	&#125;</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>
<p><strong>流式文件读取</strong></p>
<ul>
<li>简单文件读取的方式会一次性读取文件内容到内存中，若文件较大，会占用过多内存影响系统性能，且读取速度慢</li>
<li>大文件适合用流式文件读取，它会分多次将文件读取到内存中</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line">var fs = require(&apos;fs&apos;)</span><br><span class="line"></span><br><span class="line">// 创建一个可读流</span><br><span class="line">var rs = fs.createReadStream(&apos;C:/Users/笔记.mp3&apos;)</span><br><span class="line">// 创建一个可写流</span><br><span class="line">var ws = fs.createWriteStream(&apos;a.mp3&apos;)</span><br><span class="line"></span><br><span class="line">// 监听流的开启和关闭</span><br><span class="line">// 这几个监听不是必须的</span><br><span class="line">rs.once(&apos;open&apos;, function () &#123;</span><br><span class="line">  console.log(&apos;可读流打开了~~&apos;)</span><br><span class="line">&#125;)</span><br><span class="line"></span><br><span class="line">rs.once(&apos;close&apos;, function () &#123;</span><br><span class="line">  console.log(&apos;可读流关闭了~~&apos;)</span><br><span class="line">  //数据读取完毕，关闭可写流</span><br><span class="line">  ws.end()</span><br><span class="line">&#125;)</span><br><span class="line"></span><br><span class="line">ws.once(&apos;open&apos;, function () &#123;</span><br><span class="line">  console.log(&apos;可写流打开了~~&apos;)</span><br><span class="line">&#125;)</span><br><span class="line"></span><br><span class="line">ws.once(&apos;close&apos;, function () &#123;</span><br><span class="line">  console.log(&apos;可写流关闭了~~&apos;)</span><br><span class="line">&#125;)</span><br><span class="line"></span><br><span class="line">//要读取一个可读流中的数据，要为可读流绑定一个data事件，data事件绑定完毕自动开始读取数据</span><br><span class="line">rs.on(&apos;data&apos;, function (data) &#123;</span><br><span class="line">  console.log(data)</span><br><span class="line">  //将读取到的数据写入到可写流中</span><br><span class="line">  ws.write(data)</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure>
<p> 简便方式： </p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> fs = <span class="built_in">require</span>(<span class="string">'fs'</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> rs = fs.createReadStream(<span class="string">'C:/Users/lilichao/Desktop/笔记.mp3'</span>)</span><br><span class="line"><span class="keyword">var</span> ws = fs.createWriteStream(<span class="string">'b.mp3'</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment">// pipe()可以将可读流中的内容，直接输出到可写流中</span></span><br><span class="line">rs.pipe(ws)</span><br></pre></td></tr></table></figure>
<p><strong>写入文件</strong></p>
<p>简单文件写入</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">fs.writeFile(file,data,[options],callback)</span><br></pre></td></tr></table></figure>
<p>file：文件路径</p>
<p>data：写入内容</p>
<p>options：配置选项，包含 encoding，mode，flag；若是字符串则指定编码格式</p>
<p>callback：回调函数</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">const fs = require(&apos;fs&apos;)</span><br><span class="line">fs.writeFile(&apos;./files/2.txt&apos;, &apos;Hello Nodejs&apos;, function (err) &#123;</span><br><span class="line">  if (err) &#123;</span><br><span class="line">    return console.log(&apos;failed!&apos; + err.message)</span><br><span class="line">  &#125;</span><br><span class="line">  console.log(&apos;success!&apos;)</span><br><span class="line">&#125;)</span><br><span class="line"></span><br><span class="line">fs.writeFile(&apos;C:/Users/hello.txt&apos;, &apos;通过 writeFile 写入的内容&apos;, &#123; flag: &apos;w&apos; &#125;, function (err) &#123;</span><br><span class="line">  if (!err) &#123;</span><br><span class="line">    console.log(&apos;写入成功！&apos;)</span><br><span class="line">  &#125; else &#123;</span><br><span class="line">    console.log(err)</span><br><span class="line">  &#125;</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure>
<p><strong>流式文件写入</strong></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line">// 同步、异步、简单文件的写入都不适合大文件的写入，性能较差，容易导致内存溢出</span><br><span class="line">var fs = require(&apos;fs&apos;)</span><br><span class="line"></span><br><span class="line">// 创建一个可写流</span><br><span class="line">var ws = fs.createWriteStream(&apos;hello3.txt&apos;)</span><br><span class="line"></span><br><span class="line">ws.once(&apos;open&apos;, function () &#123;</span><br><span class="line">  console.log(&apos;流打开了~~&apos;)</span><br><span class="line">&#125;)</span><br><span class="line"></span><br><span class="line">ws.once(&apos;close&apos;, function () &#123;</span><br><span class="line">  console.log(&apos;流关闭了~~&apos;)</span><br><span class="line">&#125;)</span><br><span class="line"></span><br><span class="line">// 通过ws向文件中输出内容</span><br><span class="line">ws.write(&apos;通过可写流写入文件的内容&apos;)</span><br><span class="line">ws.write(&apos;1&apos;)</span><br><span class="line">ws.write(&apos;2&apos;)</span><br><span class="line">ws.write(&apos;3&apos;)</span><br><span class="line">ws.write(&apos;4&apos;)</span><br><span class="line"></span><br><span class="line">// 关闭流</span><br><span class="line">ws.end()</span><br></pre></td></tr></table></figure>
<h3 id="路径动态拼接问题-dirname"><a href="#路径动态拼接问题-dirname" class="headerlink" title="路径动态拼接问题 __dirname"></a>路径动态拼接问题 <code>__dirname</code></h3><ul>
<li>在使用 fs 模块操作文件时，如果提供的操作路径是以 <code>./</code> 或 <code>../</code> 开头的相对路径时，容易出现路径动态拼接错误的问题</li>
<li>原因：代码在运行的时候，会以执行 node 命令时所处的目录，动态拼接出被操作文件的完整路径</li>
<li>解决方案：在使用 fs 模块操作文件时，直接提供完整的路径，从而防止路径动态拼接的问题</li>
<li><code>__dirname</code> 获取文件所处的绝对路径</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">fs.readFile(__dirname + &apos;/files/1.txt&apos;, &apos;utf8&apos;, function(err, data) &#123;</span><br><span class="line">  ...</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure>
<h3 id="其它操作"><a href="#其它操作" class="headerlink" title="其它操作"></a>其它操作</h3><p>验证路径是否存在：</p>
<ul>
<li><code>fs.exists(path, callback)</code></li>
<li><code>fs.existsSync(path)</code></li>
</ul>
<p>获取文件信息：</p>
<ul>
<li><code>fs.stat(path, callback)</code></li>
<li><code>fs.stat(path)</code></li>
</ul>
<p>删除文件：</p>
<ul>
<li><code>fs.unlink(path, callback)</code></li>
<li><code>fs.unlinkSync(path)</code></li>
</ul>
<p>列出文件：</p>
<ul>
<li><code>fs.readdir(path[,options], callback)</code></li>
<li><code>fs.readdirSync(path[, options])</code></li>
</ul>
<p>截断文件：</p>
<ul>
<li><code>fs.truncate(path, len, callback)</code></li>
<li><code>fs.truncateSync(path, len)</code></li>
</ul>
<p>建立目录：</p>
<ul>
<li><code>fs.mkdir(path[, mode], callback)</code></li>
<li><code>fs.mkdirSync(path[, mode])</code></li>
</ul>
<p>删除目录：</p>
<ul>
<li><code>fs.rmdir(path, callback)</code></li>
<li><code>fs.rmdirSync(path)</code></li>
</ul>
<p>重命名文件和目录：</p>
<ul>
<li><code>fs.rename(oldPath, newPath, callback)</code></li>
<li><code>fs.renameSync(oldPath, newPath)</code></li>
</ul>
<p>监视文件更改：</p>
<ul>
<li><code>fs.watchFile(filename[, options], listener)</code></li>
</ul>
<h2 id="path-路径模块"><a href="#path-路径模块" class="headerlink" title="path 路径模块"></a>path 路径模块</h2><p>path 模块是 Node.js 官方提供的、用来处理路径的模块。它提供了一系列的方法和属性，用来满足用户对路径的处理需求。</p>
<h3 id="路径拼接-path-join"><a href="#路径拼接-path-join" class="headerlink" title="路径拼接 path.join()"></a>路径拼接 <code>path.join()</code></h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">const path = require(&apos;path&apos;)</span><br><span class="line">const fs = require(&apos;fs&apos;)</span><br><span class="line"></span><br><span class="line">// 注意 ../ 会抵消前面的路径</span><br><span class="line">// ./ 会被忽略</span><br><span class="line">const pathStr = path.join(&apos;/a&apos;, &apos;/b/c&apos;, &apos;../../&apos;, &apos;./d&apos;, &apos;e&apos;)</span><br><span class="line">console.log(pathStr) // \a\d\e</span><br><span class="line"></span><br><span class="line">fs.readFile(path.join(__dirname, &apos;./files/1.txt&apos;), &apos;utf8&apos;, function (err, dataStr) &#123;</span><br><span class="line">  if (err) &#123;</span><br><span class="line">    return console.log(err.message)</span><br><span class="line">  &#125;</span><br><span class="line">  console.log(dataStr)</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure>
<h3 id="获取路径中文件名-path-basename"><a href="#获取路径中文件名-path-basename" class="headerlink" title="获取路径中文件名 path.basename()"></a>获取路径中文件名 <code>path.basename()</code></h3><p> 使用 <code>path.basename()</code> 方法，可以获取路径中的最后一部分，常通过该方法获取路径中的文件名 </p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">path.basename(path[, ext])</span><br></pre></td></tr></table></figure>
<ul>
<li>path: 文件路径</li>
<li>ext: 文件扩展名</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">const path = require(&apos;path&apos;)</span><br><span class="line"></span><br><span class="line">// 定义文件的存放路径</span><br><span class="line">const fpath = &apos;/a/b/c/index.html&apos;</span><br><span class="line"></span><br><span class="line">const fullName = path.basename(fpath)</span><br><span class="line">console.log(fullName) // index.html</span><br><span class="line"></span><br><span class="line">const nameWithoutExt = path.basename(fpath, &apos;.html&apos;)</span><br><span class="line">console.log(nameWithoutExt) // index</span><br></pre></td></tr></table></figure>
<h3 id="获取路径中文件扩展名-path-extname"><a href="#获取路径中文件扩展名-path-extname" class="headerlink" title="获取路径中文件扩展名 path.extname()"></a>获取路径中文件扩展名 <code>path.extname()</code></h3><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> path = <span class="built_in">require</span>(<span class="string">'path'</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> fpath = <span class="string">'/a/b/c/index.html'</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> fext = path.extname(fpath)</span><br><span class="line"><span class="built_in">console</span>.log(fext) <span class="comment">// .html</span></span><br></pre></td></tr></table></figure>
<h2 id="http-模块"><a href="#http-模块" class="headerlink" title="http 模块"></a>http 模块</h2><p> http 模块是 Node.js 官方提供的、用来创建 web 服务器的模块。 </p>
<h3 id="创建基本-Web-服务器"><a href="#创建基本-Web-服务器" class="headerlink" title="创建基本 Web 服务器"></a>创建基本 Web 服务器</h3><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> http = <span class="built_in">require</span>(<span class="string">'http'</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment">// 创建 web 服务器实例</span></span><br><span class="line"><span class="keyword">const</span> server = http.createServer()</span><br><span class="line"></span><br><span class="line"><span class="comment">// 为服务器实例绑定 request 事件，监听客户端的请求</span></span><br><span class="line">server.on(<span class="string">'request'</span>, <span class="function"><span class="keyword">function</span> (<span class="params">req, res</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">const</span> url = req.url</span><br><span class="line">  <span class="keyword">const</span> method = req.method</span><br><span class="line">  <span class="keyword">const</span> str = <span class="string">`Your request url is <span class="subst">$&#123;url&#125;</span>, and request method is <span class="subst">$&#123;method&#125;</span>`</span></span><br><span class="line">  <span class="built_in">console</span>.log(str)</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 设置 Content-Type 响应头，解决中文乱码的问题</span></span><br><span class="line">  res.setHeader(<span class="string">'Content-Type'</span>, <span class="string">'text/html; charset=utf-8'</span>)</span><br><span class="line">  <span class="comment">// 向客户端响应内容</span></span><br><span class="line">  res.end(str)</span><br><span class="line">&#125;)</span><br><span class="line"></span><br><span class="line">server.listen(<span class="number">8080</span>, <span class="function"><span class="keyword">function</span> (<span class="params"></span>) </span>&#123;</span><br><span class="line">  <span class="built_in">console</span>.log(<span class="string">'server running at http://127.0.0.1:8080'</span>)</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure>
<h3 id="实现简陋路由效果"><a href="#实现简陋路由效果" class="headerlink" title="实现简陋路由效果"></a>实现简陋路由效果</h3><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> http = <span class="built_in">require</span>(<span class="string">'http'</span>)</span><br><span class="line"><span class="keyword">const</span> server = http.createServer()</span><br><span class="line"></span><br><span class="line">server.on(<span class="string">'request'</span>, (req, res) =&gt; &#123;</span><br><span class="line">  <span class="keyword">const</span> url = req.url</span><br><span class="line">  <span class="comment">// 设置默认的响应内容为 404 Not found</span></span><br><span class="line">  <span class="keyword">let</span> content = <span class="string">'&lt;h1&gt;404 Not found!&lt;/h1&gt;'</span></span><br><span class="line">  <span class="comment">// 判断用户请求的是否为 / 或 /index.html 首页</span></span><br><span class="line">  <span class="comment">// 判断用户请求的是否为 /about.html 关于页面</span></span><br><span class="line">  <span class="keyword">if</span> (url === <span class="string">'/'</span> || url === <span class="string">'/index.html'</span>) &#123;</span><br><span class="line">    content = <span class="string">'&lt;h1&gt;首页&lt;/h1&gt;'</span></span><br><span class="line">  &#125; <span class="keyword">else</span> <span class="keyword">if</span> (url === <span class="string">'/about.html'</span>) &#123;</span><br><span class="line">    content = <span class="string">'&lt;h1&gt;关于页面&lt;/h1&gt;'</span></span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  res.setHeader(<span class="string">'Content-Type'</span>, <span class="string">'text/html; charset=utf-8'</span>)</span><br><span class="line">  res.end(content)</span><br><span class="line">&#125;)</span><br><span class="line"></span><br><span class="line">server.listen(<span class="number">80</span>, () =&gt; &#123;</span><br><span class="line">  <span class="built_in">console</span>.log(<span class="string">'server running at http://127.0.0.1'</span>)</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure>
<h2 id="模块化"><a href="#模块化" class="headerlink" title="模块化"></a>模块化</h2><h3 id="模块化概念"><a href="#模块化概念" class="headerlink" title="模块化概念"></a>模块化概念</h3><ul>
<li>模块化是指解决一个复杂问题时，自顶向下逐层把系统划分为若干模块的过程，模块是可组合、分解和更换的单元。</li>
<li>模块化可提高代码的复用性和可维护性，实现按需加载。</li>
<li>模块化规范是对代码进行模块化拆分和组合时需要遵守的规则，如使用何种语法格式引用模块和向外暴露成员。</li>
</ul>
<h3 id="Node-js-中模块的分类"><a href="#Node-js-中模块的分类" class="headerlink" title="Node.js 中模块的分类"></a>Node.js 中模块的分类</h3><ul>
<li>内置模块</li>
<li>自定义模块</li>
<li>第三方模块</li>
</ul>
<h3 id="Node-js-中的模块作用域"><a href="#Node-js-中的模块作用域" class="headerlink" title="Node.js 中的模块作用域"></a>Node.js 中的模块作用域</h3><ul>
<li>和函数作用域类似，在自定义模块中定义的变量、方法等成员，只能在当前模块内被访问，这种模块级别的访问限制，叫做模块作用域</li>
<li>防止全局变量污染</li>
</ul>
<h3 id="模块作用域的成员"><a href="#模块作用域的成员" class="headerlink" title="模块作用域的成员"></a>模块作用域的成员</h3><ul>
<li>自定义模块中都有一个 <code>module</code> 对象，存储了和当前模块有关的信息</li>
<li>在自定义模块中，可以使用 <code>module.exports</code> 对象，将模块内的成员共享出去，供外界使用。导入自定义模块时，得到的就是 <code>module.exports</code> 指向的对象。</li>
<li>默认情况下，<code>exports</code> 和 <code>module.exports</code> 指向同一个对象。最终共享的结果，以 <code>module.exports</code> 指向的对象为准。</li>
</ul>
<h3 id="CommonJS-模块化规范"><a href="#CommonJS-模块化规范" class="headerlink" title="CommonJS 模块化规范"></a>CommonJS 模块化规范</h3><ul>
<li>每个模块内部，<code>module</code> 变量代表当前模块</li>
<li><code>module</code> 变量是一个对象，<code>module.exports</code> 是对外的接口</li>
<li>加载某个模块即加载该模块的 <code>module.exports</code> 属性</li>
</ul>
<h3 id="模块加载机制"><a href="#模块加载机制" class="headerlink" title="模块加载机制"></a>模块加载机制</h3><p>模块第一次加载后会被缓存，即多次调用 <code>require()</code> 不会导致模块的代码被执行多次，提高模块加载效率。</p>
<h4 id="内置模块加载"><a href="#内置模块加载" class="headerlink" title="内置模块加载"></a>内置模块加载</h4><p>内置模块加载优先级最高。</p>
<h4 id="自定义模块加载"><a href="#自定义模块加载" class="headerlink" title="自定义模块加载"></a>自定义模块加载</h4><p>加载自定义模块时，路径要以 <code>./</code> 或 <code>../</code> 开头，否则会作为内置模块或第三方模块加载。</p>
<p>导入自定义模块时，若省略文件扩展名，则 Node.js 会按顺序尝试加载文件：</p>
<ul>
<li>按确切的文件名加载</li>
<li>补全 <code>.js</code> 扩展名加载</li>
<li>补全 <code>.json</code> 扩展名加载</li>
<li>补全 <code>.node</code> 扩展名加载</li>
<li>报错</li>
</ul>
<h4 id="第三方模块加载"><a href="#第三方模块加载" class="headerlink" title="第三方模块加载"></a>第三方模块加载</h4><ul>
<li>若导入第三方模块， Node.js 会从<strong>当前模块的父目录</strong>开始，尝试从 <code>/node_modules</code> 文件夹中加载第三方模块。</li>
<li>如果没有找到对应的第三方模块，则移动到再<strong>上一层父目录</strong>中，进行加载，直到<strong>文件系统的根目录</strong>。</li>
</ul>
<p>例如，假设在 <code>C:\Users\bruce\project\foo.js</code> 文件里调用了 <code>require(&#39;tools&#39;)</code>，则 Node.js 会按以下顺序查找：</p>
<ul>
<li><code>C:\Users\bruce\project\node_modules\tools</code></li>
<li><code>C:\Users\bruce\node_modules\tools</code></li>
<li><code>C:\Users\node_modules\tools</code></li>
<li><code>C:\node_modules\tools</code></li>
</ul>
<h4 id="目录作为模块加载"><a href="#目录作为模块加载" class="headerlink" title="目录作为模块加载"></a>目录作为模块加载</h4><p>当把目录作为模块标识符进行加载的时候，有三种加载方式：</p>
<ul>
<li>在被加载的目录下查找 <code>package.json</code> 的文件，并寻找 <code>main</code> 属性，作为 <code>require()</code> 加载的入口</li>
<li>如果没有 <code>package.json</code> 文件，或者 <code>main</code> 入口不存在或无法解析，则 Node.js 将会试图加载目录下的 <code>index.js</code> 文件。</li>
<li>若失败则报错</li>
</ul>
<h2 id="Express"><a href="#Express" class="headerlink" title="Express"></a>Express</h2><blockquote>
<p>基于 Node.js 平台，快速、开放、极简的 Web 开发框架</p>
</blockquote>
<p>Express 是用于快速创建服务器的第三方模块。</p>
<h2 id="Express-初体验"><a href="#Express-初体验" class="headerlink" title="Express 初体验"></a>Express 初体验</h2><h3 id="基本使用"><a href="#基本使用" class="headerlink" title="基本使用"></a>基本使用</h3><p>安装 Express：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">npm install express</span><br></pre></td></tr></table></figure>
<p> 创建服务器，监听客户端请求，并返回内容： </p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> express = <span class="built_in">require</span>(<span class="string">'express'</span>)</span><br><span class="line"><span class="comment">// 创建 web 服务器</span></span><br><span class="line"><span class="keyword">const</span> app = express()</span><br><span class="line"></span><br><span class="line"><span class="comment">// 监听客户端的 GET 和 POST 请求，并向客户端响应具体的内容</span></span><br><span class="line">app.get(<span class="string">'/user'</span>, (req, res) =&gt; &#123;</span><br><span class="line">  res.send(&#123; <span class="attr">name</span>: <span class="string">'zs'</span>, <span class="attr">age</span>: <span class="number">20</span>, <span class="attr">gender</span>: <span class="string">'男'</span> &#125;)</span><br><span class="line">&#125;)</span><br><span class="line">app.post(<span class="string">'/user'</span>, (req, res) =&gt; &#123;</span><br><span class="line">  res.send(<span class="string">'请求成功'</span>)</span><br><span class="line">&#125;)</span><br><span class="line"></span><br><span class="line">app.get(<span class="string">'/'</span>, (req, res) =&gt; &#123;</span><br><span class="line">  <span class="comment">// 通过 req.query 可以获取到客户端发送过来的查询参数</span></span><br><span class="line">  <span class="built_in">console</span>.log(req.query)</span><br><span class="line">  res.send(req.query)</span><br><span class="line">&#125;)</span><br><span class="line"></span><br><span class="line"><span class="comment">// 这里的 :id 是一个动态的参数</span></span><br><span class="line">app.get(<span class="string">'/user/:ids/:username'</span>, (req, res) =&gt; &#123;</span><br><span class="line">  <span class="comment">// req.params 是动态匹配到的 URL 参数，默认是一个空对象</span></span><br><span class="line">  <span class="built_in">console</span>.log(req.params)</span><br><span class="line">  res.send(req.params)</span><br><span class="line">&#125;)</span><br><span class="line"></span><br><span class="line">app.listen(<span class="number">80</span>, () =&gt; &#123;</span><br><span class="line">  <span class="built_in">console</span>.log(<span class="string">'express server running at http://127.0.0.1'</span>)</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure>
<h3 id="托管静态资源"><a href="#托管静态资源" class="headerlink" title="托管静态资源"></a>托管静态资源</h3><ul>
<li>通过 <code>express.static()</code> 方法可创建静态资源服务器，向外开放访问静态资源。</li>
<li>Express 在指定的静态目录中查找文件，并对外提供资源的访问路径，存放静态文件的目录名不会出现在 URL 中</li>
<li>访问静态资源时，会根据托管顺序查找文件</li>
<li>可为静态资源访问路径添加前缀</li>
</ul>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">app.use(express.static(<span class="string">'public'</span>))</span><br><span class="line">app.use(express.static(<span class="string">'files'</span>))</span><br><span class="line">app.use(<span class="string">'/bruce'</span>, express.static(<span class="string">'bruce'</span>))</span><br><span class="line"></span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment">可直接访问 public, files 目录下的静态资源</span></span><br><span class="line"><span class="comment">http://localhost:3000/images/bg.jpg</span></span><br><span class="line"><span class="comment">http://localhost:3000/css/style.css</span></span><br><span class="line"><span class="comment">http://localhost:3000/js/login.js</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">通过带有 /bruce 前缀的地址访问 bruce 目录下的文件</span></span><br><span class="line"><span class="comment">http://localhost:8080/bruce/images/logo.png</span></span><br><span class="line"><span class="comment">*/</span></span><br></pre></td></tr></table></figure>
<h2 id="Express-路由"><a href="#Express-路由" class="headerlink" title="Express 路由"></a>Express 路由</h2><p>创建路由模块：</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// router.js</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> express = <span class="built_in">require</span>(<span class="string">'express'</span>)</span><br><span class="line"><span class="comment">// 创建路由对象</span></span><br><span class="line"><span class="keyword">const</span> router = express.Router()</span><br><span class="line"></span><br><span class="line"><span class="comment">// 挂载具体路由</span></span><br><span class="line">router.get(<span class="string">'/user/list'</span>, (req, res) =&gt; &#123;</span><br><span class="line">  res.send(<span class="string">'Get user list.'</span>)</span><br><span class="line">&#125;)</span><br><span class="line">router.post(<span class="string">'/user/add'</span>, (req, res) =&gt; &#123;</span><br><span class="line">  res.send(<span class="string">'Add new user.'</span>)</span><br><span class="line">&#125;)</span><br><span class="line"></span><br><span class="line"><span class="comment">// 向外导出路由对象</span></span><br><span class="line"><span class="built_in">module</span>.exports = router</span><br></pre></td></tr></table></figure>
<p> 注册路由模块： </p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> express = <span class="built_in">require</span>(<span class="string">'express'</span>)</span><br><span class="line"><span class="keyword">const</span> router = <span class="built_in">require</span>(<span class="string">'./router'</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> app = express()</span><br><span class="line"></span><br><span class="line"><span class="comment">// 注册路由模块，添加访问前缀</span></span><br><span class="line">app.use(<span class="string">'/api'</span>, router)</span><br><span class="line"></span><br><span class="line">app.listen(<span class="number">80</span>, () =&gt; &#123;</span><br><span class="line">  <span class="built_in">console</span>.log(<span class="string">'http://127.0.0.1'</span>)</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure>
<h2 id="Express-中间件"><a href="#Express-中间件" class="headerlink" title="Express 中间件"></a>Express 中间件</h2><ul>
<li>中间件是指流程的中间处理环节</li>
<li>服务器收到请求后，可先调用中间件进行预处理</li>
<li>中间件是一个函数，包含 <code>req, res, next</code> 三个参数，<code>next()</code> 参数把流转关系交给下一个中间件或路由</li>
</ul>
<p>中间件注意事项；</p>
<ul>
<li>在注册路由之前注册中间件（错误级别中间件除外）</li>
<li>中间件可连续调用多个</li>
<li>别忘记调用 <code>next()</code> 函数</li>
<li><code>next()</code> 函数后别写代码</li>
<li>多个中间件共享 <code>req</code>、 <code>res</code>对象</li>
</ul>
<h3 id="全局中间件"><a href="#全局中间件" class="headerlink" title="全局中间件"></a>全局中间件</h3><ul>
<li>通过 <code>app.use()</code> 定义的中间件为全局中间件</li>
</ul>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> express = <span class="built_in">require</span>(<span class="string">'express'</span>)</span><br><span class="line"><span class="keyword">const</span> app = express()</span><br><span class="line"></span><br><span class="line"><span class="comment">// 定义第一个全局中间件</span></span><br><span class="line">app.use(<span class="function">(<span class="params">req, res, next</span>) =&gt;</span> &#123;</span><br><span class="line">  <span class="built_in">console</span>.log(<span class="string">'调用了第1个全局中间件'</span>)</span><br><span class="line">  next()</span><br><span class="line">&#125;)</span><br><span class="line"><span class="comment">// 定义第二个全局中间件</span></span><br><span class="line">app.use(<span class="function">(<span class="params">req, res, next</span>) =&gt;</span> &#123;</span><br><span class="line">  <span class="built_in">console</span>.log(<span class="string">'调用了第2个全局中间件'</span>)</span><br><span class="line">  next()</span><br><span class="line">&#125;)</span><br><span class="line"></span><br><span class="line">app.get(<span class="string">'/user'</span>, (req, res) =&gt; &#123;</span><br><span class="line">  res.send(<span class="string">'User page.'</span>)</span><br><span class="line">&#125;)</span><br><span class="line"></span><br><span class="line">app.listen(<span class="number">80</span>, () =&gt; &#123;</span><br><span class="line">  <span class="built_in">console</span>.log(<span class="string">'http://127.0.0.1'</span>)</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure>
<h3 id="局部中间件"><a href="#局部中间件" class="headerlink" title="局部中间件"></a>局部中间件</h3><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> express = <span class="built_in">require</span>(<span class="string">'express'</span>)</span><br><span class="line"><span class="keyword">const</span> app = express()</span><br><span class="line"></span><br><span class="line"><span class="comment">// 定义中间件函数</span></span><br><span class="line"><span class="keyword">const</span> mw1 = <span class="function">(<span class="params">req, res, next</span>) =&gt;</span> &#123;</span><br><span class="line">  <span class="built_in">console</span>.log(<span class="string">'调用了第一个局部生效的中间件'</span>)</span><br><span class="line">  next()</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> mw2 = <span class="function">(<span class="params">req, res, next</span>) =&gt;</span> &#123;</span><br><span class="line">  <span class="built_in">console</span>.log(<span class="string">'调用了第二个局部生效的中间件'</span>)</span><br><span class="line">  next()</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 两种定义局部中间件的方式</span></span><br><span class="line">app.get(<span class="string">'/hello'</span>, mw2, mw1, (req, res) =&gt; res.send(<span class="string">'hello page.'</span>))</span><br><span class="line">app.get(<span class="string">'/about'</span>, [mw1, mw2], (req, res) =&gt; res.send(<span class="string">'about page.'</span>))</span><br><span class="line"></span><br><span class="line">app.get(<span class="string">'/user'</span>, (req, res) =&gt; res.send(<span class="string">'User page.'</span>))</span><br><span class="line"></span><br><span class="line">app.listen(<span class="number">80</span>, <span class="function"><span class="keyword">function</span> (<span class="params"></span>) </span>&#123;</span><br><span class="line">  <span class="built_in">console</span>.log(<span class="string">'Express server running at http://127.0.0.1'</span>)</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure>
<h3 id="中间件分类"><a href="#中间件分类" class="headerlink" title="中间件分类"></a>中间件分类</h3><ol>
<li>应用级别的中间件</li>
</ol>
<ul>
<li>通过 <code>app.use()</code> 或 <code>app.get()</code> 或 <code>app.post()</code> ，绑定到 <code>app</code> 实例上的中间件</li>
</ul>
<p>2.路由级别的中间件</p>
<ul>
<li>绑定到 <code>express.Router()</code> 实例上的中间件，叫做路由级别的中间件。用法和应用级别中间件没有区别。应用级别中间件是绑定到 <code>app</code> 实例上，路由级别中间件绑定到 <code>router</code> 实例上。</li>
</ul>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> app = express()</span><br><span class="line"><span class="keyword">const</span> router = express.Router()</span><br><span class="line"></span><br><span class="line">router.use(<span class="function"><span class="keyword">function</span> (<span class="params">req, res, next</span>) </span>&#123;</span><br><span class="line">  <span class="built_in">console</span>.log(<span class="number">1</span>)</span><br><span class="line">  next()</span><br><span class="line">&#125;)</span><br><span class="line"></span><br><span class="line">app.use(<span class="string">'/'</span>, router)</span><br></pre></td></tr></table></figure>
<p>3.错误级别的中间件</p>
<ul>
<li>用来捕获整个项目中发生的异常错误，从而防止项目异常崩溃的问题</li>
<li>错误级别中间件的处理函数中，必须有 4 个形参，形参顺序从前到后分别是 <code>(err, req, res, next)</code> 。</li>
<li>错误级别的中间件必须注册在所有路由之后</li>
</ul>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> express = <span class="built_in">require</span>(<span class="string">'express'</span>)</span><br><span class="line"><span class="keyword">const</span> app = express()</span><br><span class="line"></span><br><span class="line">app.get(<span class="string">'/'</span>, (req, res) =&gt; &#123;</span><br><span class="line">  <span class="keyword">throw</span> <span class="keyword">new</span> <span class="built_in">Error</span>(<span class="string">'服务器内部发生了错误！'</span>)</span><br><span class="line">  res.send(<span class="string">'Home page.'</span>)</span><br><span class="line">&#125;)</span><br><span class="line"></span><br><span class="line"><span class="comment">// 定义错误级别的中间件，捕获整个项目的异常错误，从而防止程序的崩溃</span></span><br><span class="line">app.use(<span class="function">(<span class="params">err, req, res, next</span>) =&gt;</span> &#123;</span><br><span class="line">  <span class="built_in">console</span>.log(<span class="string">'发生了错误！'</span> + err.message)</span><br><span class="line">  res.send(<span class="string">'Error：'</span> + err.message)</span><br><span class="line">&#125;)</span><br><span class="line"></span><br><span class="line">app.listen(<span class="number">80</span>, <span class="function"><span class="keyword">function</span> (<span class="params"></span>) </span>&#123;</span><br><span class="line">  <span class="built_in">console</span>.log(<span class="string">'Express server running at http://127.0.0.1'</span>)</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure>
<p>4.Express 内置中间件</p>
<p>自 Express 4.16.0 版本开始，Express 内置了 3 个常用的中间件，极大的提高了 Express 项目的开发效率和体验：</p>
<ul>
<li><code>express.static</code> 快速托管静态资源的内置中间件，例如： HTML 文件、图片、CSS 样式等（无兼容性）</li>
<li><code>express.json</code> 解析 JSON 格式的请求体数据（有兼容性，仅在 4.16.0+ 版本中可用）</li>
<li><code>express.urlencoded</code> 解析 URL-encoded 格式的请求体数据（有兼容性，仅在 4.16.0+ 版本中可用）</li>
</ul>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">app.use(express.json())</span><br><span class="line">app.use(express.urlencoded(&#123; <span class="attr">extended</span>: <span class="literal">false</span> &#125;))</span><br></pre></td></tr></table></figure>
<p>5.第三方中间件</p>
<h2 id="CORS-跨域资源共享"><a href="#CORS-跨域资源共享" class="headerlink" title="CORS 跨域资源共享"></a>CORS 跨域资源共享</h2><h3 id="cors-中间件解决跨域"><a href="#cors-中间件解决跨域" class="headerlink" title="cors 中间件解决跨域"></a>cors 中间件解决跨域</h3><ul>
<li>安装中间件：<code>npm install cors</code></li>
<li>导入中间件：<code>const cors = require(&#39;cors&#39;)</code></li>
<li>配置中间件：<code>app.use(cors())</code></li>
</ul>
<h3 id="CORS"><a href="#CORS" class="headerlink" title="CORS"></a>CORS</h3><ul>
<li>CORS（Cross-Origin Resource Sharing，跨域资源共享）解决跨域，是通过 HTTP 响应头决定浏览器是否阻止前端 JS 代码跨域获取资源</li>
<li>浏览器的同源安全策略默认会阻止网页“跨域”获取资源。但如果接口服务器配置了 CORS 相关的 HTTP 响应头，就可解除浏览器端的跨域访问限制</li>
<li>CORS 主要在服务器端进行配置。客户端浏览器无须做任何额外的配置，即可请求开启了 CORS 的接口。</li>
<li>CORS 在浏览器中有兼容性。只有支持 XMLHttpRequest Level2 的浏览器，才能正常访问开启了 CORS 的服务端接口（例如：IE10+、Chrome4+、FireFox3.5+）。</li>
</ul>
<h3 id="CORS-常见响应头"><a href="#CORS-常见响应头" class="headerlink" title="CORS 常见响应头"></a>CORS 常见响应头</h3><ul>
<li><code>Access-Control-Allow-Origin</code>：制定了允许访问资源的外域 URL</li>
</ul>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">res.setHeader(<span class="string">'Access-Control-Allow-Origin'</span>, <span class="string">'http://bruceblog.io'</span>)</span><br><span class="line">res.setHeader(<span class="string">'Access-Control-Allow-Origin'</span>, <span class="string">'*'</span>)</span><br></pre></td></tr></table></figure>
<ul>
<li><code>Access-Control-Allow-Headers</code></li>
<li>默认情况下，CORS 仅支持客户端向服务器发送如下的 9 个请求头：<code>Accept、Accept-Language、Content-Language、DPR、Downlink、Save-Data、Viewport-Width、Width 、Content-Type （值仅限于 text/plain、multipart/form-data、application/x-www-form-urlencoded 三者之一）</code></li>
<li>如果客户端向服务器发送了额外的请求头信息，则需要在服务器端，通过 A<code>ccess-Control-Allow-Headers</code> 对额外的请求头进行声明，否则这次请求会失败！</li>
</ul>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">res.setHeader(<span class="string">'Access-Control-Allow-Headers'</span>, <span class="string">'Content-Type, X-Custom-Header'</span>)</span><br></pre></td></tr></table></figure>
<ul>
<li><code>Access-Control-Allow-Methods</code></li>
<li>默认情况下，CORS 仅支持客户端发起 GET、POST、HEAD 请求。如果客户端希望通过 PUT、DELETE 等方式请求服务器的资源，则需要在服务器端，通过 <code>Access-Control-Alow-Methods</code> 来指明实际请求所允许使用的 HTTP 方法</li>
</ul>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">res.setHeader(<span class="string">'Access-Control-Allow-Methods'</span>, <span class="string">'POST, GET, DELETE, HEAD'</span>)</span><br><span class="line">res.setHEader(<span class="string">'Access-Control-Allow-Methods'</span>, <span class="string">'*'</span>)</span><br></pre></td></tr></table></figure>
<h3 id="CORS-请求分类"><a href="#CORS-请求分类" class="headerlink" title="CORS 请求分类"></a>CORS 请求分类</h3><h4 id="简单请求"><a href="#简单请求" class="headerlink" title="简单请求"></a>简单请求</h4><ul>
<li>请求方式：GET、POST、HEAD 三者之一</li>
<li>HTTP 头部信息不超过以下几种字段：无自定义头部字段、Accept、Accept-Language、Content-Language、DPR、Downlink、Save-Data、Viewport-Width、Width 、Content-Type（只有三个值 application/x-www-formurlencoded、multipart/form-data、text/plain）</li>
</ul>
<h4 id="预检请求"><a href="#预检请求" class="headerlink" title="预检请求"></a>预检请求</h4><ul>
<li>请求方式为 GET、POST、HEAD 之外的请求 Method 类型</li>
<li>请求头中包含自定义头部字段</li>
<li>向服务器发送了 application/json 格式的数据</li>
</ul>
<p>在浏览器与服务器正式通信之前，浏览器会先发送 OPTION 请求进行预检，以获知服务器是否允许该实际请求，所以这一次的 OPTION 请求称为“预检请求”。服务器成功响应预检请求后，才会发送真正的请求，并且携带真实数据</p>
<h1 id="数据库和身份认证"><a href="#数据库和身份认证" class="headerlink" title="数据库和身份认证"></a>数据库和身份认证</h1><h2 id="Node-操作-mysql"><a href="#Node-操作-mysql" class="headerlink" title="Node 操作 mysql"></a>Node 操作 mysql</h2><h3 id="配置-mysql-模块"><a href="#配置-mysql-模块" class="headerlink" title="配置 mysql 模块"></a>配置 mysql 模块</h3><p>1、安装 mysql 模块</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">npm install mysql</span><br></pre></td></tr></table></figure>
<p>2、建立连接</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> mysql = <span class="built_in">require</span>(<span class="string">'mysql'</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> db = mysql.createPool(&#123;</span><br><span class="line">  host: <span class="string">'127.0.0.1'</span>,</span><br><span class="line">  user: <span class="string">'root'</span>,</span><br><span class="line">  password: <span class="string">'root'</span>,</span><br><span class="line">  database: <span class="string">'test'</span>,</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure>
<p>3、测试是否正常工作</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">db.query(<span class="string">'select 1'</span>, (err, results) =&gt; &#123;</span><br><span class="line">  <span class="keyword">if</span> (err) <span class="keyword">return</span> <span class="built_in">console</span>.log(err.message)</span><br><span class="line">  <span class="built_in">console</span>.log(results)</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure>
<h3 id="操作-mysql-数据库"><a href="#操作-mysql-数据库" class="headerlink" title="操作 mysql 数据库"></a>操作 mysql 数据库</h3><p>1、查询数据</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">db.query(<span class="string">'select * from users'</span>, (err, results) =&gt; &#123;</span><br><span class="line">  ...</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure>
<p>2、插入数据</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// ? 表示占位符</span></span><br><span class="line"><span class="keyword">const</span> sql = <span class="string">'insert into users values(?, ?)'</span></span><br><span class="line"><span class="comment">// 使用数组的形式为占位符指定具体的值</span></span><br><span class="line">db.query(sql, [username, password], (err, results) =&gt; &#123;</span><br><span class="line">  <span class="keyword">if</span> (err) <span class="keyword">return</span> <span class="built_in">console</span>.log(err.message)</span><br><span class="line">  <span class="keyword">if</span> (results.affectedRows === <span class="number">1</span>) <span class="built_in">console</span>.log(<span class="string">'插入成功'</span>)</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure>
<p> 向表中新增数据时，如果数据对象的每个属性和数据表的字段一一对应，则可以通过如下方式快速插入数据： </p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> user = &#123;<span class="attr">username</span>:<span class="string">'Bruce'</span>, <span class="attr">password</span>:<span class="string">'55520'</span>&#125;</span><br><span class="line"><span class="keyword">const</span> sql = <span class="string">'insert into users set ?'</span></span><br><span class="line">db.query(sql, user, (err, results) =&gt; &#123;</span><br><span class="line">  ...</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure>
<p>3、更新数据</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> sql = <span class="string">'update users set username=?, password=? where id=?'</span></span><br><span class="line">db.query(sql, [username, password, id], (err, results) =&gt; &#123;</span><br><span class="line">  ...</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure>
<p> 快捷方式： </p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> user = &#123;<span class="attr">id</span>:<span class="number">7</span>,<span class="attr">username</span>:<span class="string">'Bruce'</span>,<span class="attr">password</span>:<span class="string">'55520'</span>&#125;</span><br><span class="line"><span class="keyword">const</span> sql = <span class="string">'update users set ? where id=?'</span></span><br><span class="line">db.query(sql, [user, user.id], (err, results) =&gt; &#123;</span><br><span class="line">  ...</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure>
<p>4、删除数据</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> sql = <span class="string">'delete from users where id=?'</span></span><br><span class="line">db.query(sql, id, (err, results) =&gt; &#123;</span><br><span class="line">  ...</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure>
<p> 使用 delete 语句会真正删除数据，保险起见，使用标记删除的形式，模拟删除的动作。即在表中设置状态字段，标记当前的数据是否被删除。 </p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">db.query(<span class="string">'update users set status=1 where id=?'</span>, <span class="number">7</span>, (err, results) =&gt; &#123;</span><br><span class="line">  ...</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure>
<h2 id="Web-开发模式"><a href="#Web-开发模式" class="headerlink" title="Web 开发模式"></a>Web 开发模式</h2><h3 id="服务端渲染"><a href="#服务端渲染" class="headerlink" title="服务端渲染"></a>服务端渲染</h3><p>服务器发送给客户端的 HTML 页面，是在服务器通过字符串的拼接动态生成的。因此客户端不需要使用 Ajax 额外请求页面的数据。</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">app.get(<span class="string">'/index.html'</span>, (req, res) =&gt; &#123;</span><br><span class="line">  <span class="keyword">const</span> user = &#123; <span class="attr">name</span>: <span class="string">'Bruce'</span>, <span class="attr">age</span>: <span class="number">29</span> &#125;</span><br><span class="line">  <span class="keyword">const</span> html = <span class="string">`&lt;h1&gt;username:<span class="subst">$&#123;user.name&#125;</span>, age:<span class="subst">$&#123;user.age&#125;</span>&lt;/h1&gt;`</span></span><br><span class="line">  res.send(html)</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure>
<p>优点：</p>
<ul>
<li>前端耗时短。浏览器只需直接渲染页面，无需额外请求数据。</li>
<li>有利于 SEO。服务器响应的是完整的 HTML 页面内容，有利于爬虫爬取信息。</li>
</ul>
<p>缺点：</p>
<ul>
<li>占用服务器资源。服务器需要完成页面内容的拼接，若请求比较多，会对服务器造成一定访问压力。</li>
<li>不利于前后端分离，开发效率低。</li>
</ul>
<h3 id="前后端分离"><a href="#前后端分离" class="headerlink" title="前后端分离"></a>前后端分离</h3><p>前后端分离的开发模式，依赖于 Ajax 技术的广泛应用。后端只负责提供 API 接口，前端使用 Ajax 调用接口。</p>
<p>优点：</p>
<ul>
<li>开发体验好。前端专业页面开发，后端专注接口开发。</li>
<li>用户体验好。页面局部刷新，无需重新请求页面。</li>
<li>减轻服务器的渲染压力。页面最终在浏览器里生成。</li>
</ul>
<p>缺点：</p>
<ul>
<li>不利于 SEO。完整的 HTML 页面在浏览器拼接完成，因此爬虫无法爬取页面的有效信息。Vue、React 等框架的 SSR（server side render）技术能解决 SEO 问题。</li>
</ul>
<h3 id="如何选择"><a href="#如何选择" class="headerlink" title="如何选择"></a>如何选择</h3><ul>
<li>企业级网站，主要功能是展示，没有复杂交互，且需要良好的 SEO，可考虑服务端渲染</li>
<li>后台管理项目，交互性强，无需考虑 SEO，可使用前后端分离</li>
<li>为同时兼顾首页渲染速度和前后端分离开发效率，可采用首屏服务器端渲染+其他页面前后端分离的开发模式</li>
</ul>
<h2 id="身份认证"><a href="#身份认证" class="headerlink" title="身份认证"></a>身份认证</h2><h3 id="Session-认证机制"><a href="#Session-认证机制" class="headerlink" title="Session 认证机制"></a>Session 认证机制</h3><p>服务端渲染推荐使用 Session 认证机制</p>
<h4 id="Session-工作原理"><a href="#Session-工作原理" class="headerlink" title="Session 工作原理"></a>Session 工作原理</h4><p> <img src="https://brucecai55520.gitee.io/bruceblog/assets/img/Session.c66d5499.png" alt="session"> </p>
<h4 id="Express-中使用-Session-认证"><a href="#Express-中使用-Session-认证" class="headerlink" title="Express 中使用 Session 认证"></a>Express 中使用 Session 认证</h4><p>1、安装 express-session 中间件</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">npm install express-session</span><br></pre></td></tr></table></figure>
<p>2、配置中间件</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> session = <span class="built_in">require</span>(<span class="string">'express-session'</span>)</span><br><span class="line">app.use(</span><br><span class="line">  session(&#123;</span><br><span class="line">    secret: <span class="string">'Bruce'</span>, <span class="comment">// secret 的值为任意字符串</span></span><br><span class="line">    resave: <span class="literal">false</span>,</span><br><span class="line">    saveUninitalized: <span class="literal">true</span>,</span><br><span class="line">  &#125;)</span><br><span class="line">)</span><br></pre></td></tr></table></figure>
<p>3、向 session 中存数据</p>
<p>中间件配置成功后，可通过 <code>req.session</code> 访问 session 对象，存储用户信息</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">app.post(<span class="string">'/api/login'</span>, (req, res) =&gt; &#123;</span><br><span class="line">  req.session.user = req.body</span><br><span class="line">  req.session.isLogin = <span class="literal">true</span></span><br><span class="line"></span><br><span class="line">  res.send(&#123; <span class="attr">status</span>: <span class="number">0</span>, <span class="attr">msg</span>: <span class="string">'login done'</span> &#125;)</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure>
<p>4、从 session 取数据</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">app.get(<span class="string">'/api/username'</span>, (req, res) =&gt; &#123;</span><br><span class="line">  <span class="keyword">if</span> (!req.session.isLogin) &#123;</span><br><span class="line">    <span class="keyword">return</span> res.send(&#123; <span class="attr">status</span>: <span class="number">1</span>, <span class="attr">msg</span>: <span class="string">'fail'</span> &#125;)</span><br><span class="line">  &#125;</span><br><span class="line">  res.send(&#123; <span class="attr">status</span>: <span class="number">0</span>, <span class="attr">msg</span>: <span class="string">'success'</span>, <span class="attr">username</span>: req.session.user.username &#125;)</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure>
<p>5、清空 session</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">app.post(<span class="string">'/api/logout'</span>, (req, res) =&gt; &#123;</span><br><span class="line">  <span class="comment">// 清空当前客户端的session信息</span></span><br><span class="line">  req.session.destroy()</span><br><span class="line">  res.send(&#123; <span class="attr">status</span>: <span class="number">0</span>, <span class="attr">msg</span>: <span class="string">'logout done'</span> &#125;)</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure>
<h3 id="JWT-认证机制"><a href="#JWT-认证机制" class="headerlink" title="JWT 认证机制"></a>JWT 认证机制</h3><p>前后端分离推荐使用 JWT（JSON Web Token）认证机制，是目前最流行的跨域认证解决方案</p>
<h4 id="JWT-工作原理"><a href="#JWT-工作原理" class="headerlink" title="JWT 工作原理"></a>JWT 工作原理</h4><p>Session 认证的局限性：</p>
<ul>
<li>Session 认证机制需要配合 Cookie 才能实现。由于 Cookie 默认不支持跨域访问，所以，当涉及到前端跨域请求后端接口的时候，需要做很多额外的配置，才能实现跨域 Session 认证。</li>
<li>当前端请求后端接口不存在跨域问题的时候，推荐使用 Session 身份认证机制。</li>
<li>当前端需要跨域请求后端接口的时候，不推荐使用 Session 身份认证机制，推荐使用 JWT 认证机制</li>
</ul>
<p>JWT 工作原理图：</p>
<p>用户的信息通过 Token 字符串的形式，保存在客户端浏览器中。服务器通过还原 Token 字符串的形式来认证用户的身份。</p>
<p> <img src="https://brucecai55520.gitee.io/bruceblog/assets/img/JWT.6a82c41d.png" alt="JWT"> </p>
<p>JWT 组成部分：</p>
<ul>
<li>Header、Payload、Signature</li>
<li>Payload 是真正的用户信息，加密后的字符串</li>
<li>Header 和 Signature 是安全性相关部分，保证 Token 安全性</li>
<li>三者使用 <code>.</code> 分隔</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">Header.Payload.Signature</span><br><span class="line"></span><br><span class="line">eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpZCI6MTcsInVzZXJuYW1lIjoiQnJ1Y2UiLCJwYXNzd29yZCI6IiIsIm5pY2tuYW1lIjoiaGVsbG8iLCJlbWFpbCI6InNjdXRAcXEuY29tIiwidXNlcl9waWMiOiIiLCJpYXQiOjE2NDE4NjU3MzEsImV4cCI6MTY0MTkwMTczMX0.bmqzAkNSZgD8IZxRGGyVlVwGl7EGMtWitvjGD-a5U5c</span><br></pre></td></tr></table></figure>
<p>JWT 使用方式：</p>
<ul>
<li>客户端会把 JWT 存储在 localStorage 或 sessionStorage 中</li>
<li>此后客户端与服务端通信需要携带 JWT 进行身份认证，将 JWT 存在 HTTP 请求头 Authorization 字段中</li>
<li>加上 Bearer 前缀</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Authorization: Bearer &lt;token&gt;</span><br></pre></td></tr></table></figure>
<h4 id="Express-使用-JWT"><a href="#Express-使用-JWT" class="headerlink" title="Express 使用 JWT"></a>Express 使用 JWT</h4><p>1、安装</p>
<ul>
<li>jsonwebtoken 用于生成 JWT 字符串</li>
<li>express-jwt 用于将 JWT 字符串解析还原成 JSON 对象</li>
</ul>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">npm install jsonwebtoken express-jwt</span><br></pre></td></tr></table></figure>
<p>2、定义 secret 密钥</p>
<ul>
<li>为保证 JWT 字符串的安全性，防止其在网络传输过程中被破解，需定义用于加密和解密的 secret 密钥</li>
<li>生成 JWT 字符串时，使用密钥加密信息，得到加密好的 JWT 字符串</li>
<li>把 JWT 字符串解析还原成 JSON 对象时，使用密钥解密</li>
</ul>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> jwt = <span class="built_in">require</span>(<span class="string">'jsonwebtoken'</span>)</span><br><span class="line"><span class="keyword">const</span> expressJWT = <span class="built_in">require</span>(<span class="string">'express-jwt'</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment">// 密钥为任意字符串</span></span><br><span class="line"><span class="keyword">const</span> secretKey = <span class="string">'Bruce'</span></span><br></pre></td></tr></table></figure>
<p>3、生成 JWT 字符串</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">app.post(<span class="string">'/api/login'</span>, (req, res) =&gt; &#123;</span><br><span class="line">  ...</span><br><span class="line">  res.send(&#123;</span><br><span class="line">    status: <span class="number">200</span>,</span><br><span class="line">    message: <span class="string">'登录成功'</span>,</span><br><span class="line">    <span class="comment">// jwt.sign() 生成 JWT 字符串</span></span><br><span class="line">    <span class="comment">// 参数：用户信息对象、加密密钥、配置对象-token有效期</span></span><br><span class="line">    <span class="comment">// 尽量不保存敏感信息，因此只有用户名，没有密码</span></span><br><span class="line">    token: jwt.sign(&#123;<span class="attr">username</span>: userInfo.username&#125;, secretKey, &#123;<span class="attr">expiresIn</span>: <span class="string">'10h'</span>&#125;)</span><br><span class="line">  &#125;)</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure>
<p>4、JWT 字符串还原为 JSON 对象</p>
<ul>
<li>客户端访问有权限的接口时，需通过请求头的 <code>Authorization</code> 字段，将 Token 字符串发送到服务器进行身份认证</li>
<li>服务器可以通过 express-jwt 中间件将客户端发送过来的 Token 解析还原成 JSON 对象</li>
</ul>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// unless(&#123; path: [/^\/api\//] &#125;) 指定哪些接口无需访问权限</span></span><br><span class="line">app.use(expressJWT(&#123; <span class="attr">secret</span>: secretKey &#125;).unless(&#123; <span class="attr">path</span>: [<span class="regexp">/^\/api\//</span>] &#125;))</span><br></pre></td></tr></table></figure>
<p>5、获取用户信息</p>
<ul>
<li>当 express-jwt 中间件配置成功后，即可在那些有权限的接口中，使用 <code>req.user</code> 对象，来访问从 JWT 字符串中解析出来的用户信息</li>
</ul>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">app.get(<span class="string">'/admin/getinfo'</span>, (req, res) =&gt; &#123;</span><br><span class="line">  <span class="built_in">console</span>.log(req.user)</span><br><span class="line">  res.send(&#123;</span><br><span class="line">    status: <span class="number">200</span>,</span><br><span class="line">    message: <span class="string">'获取信息成功'</span>,</span><br><span class="line">    data: req.user,</span><br><span class="line">  &#125;)</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure>
<p>6、捕获解析 JWT 失败后产生的错误</p>
<ul>
<li>当使用 express-jwt 解析 Token 字符串时，如果客户端发送过来的 Token 字符串过期或不合法，会产生一个解析失败的错误，影响项目的正常运行</li>
<li>通过 Express 的错误中间件，捕获这个错误并进行相关的处理</li>
</ul>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">app.use(<span class="function">(<span class="params">err, req, res, next</span>) =&gt;</span> &#123;</span><br><span class="line">  <span class="keyword">if</span> (err.name === <span class="string">'UnauthorizedError'</span>) &#123;</span><br><span class="line">    <span class="keyword">return</span> res.send(&#123; <span class="attr">status</span>: <span class="number">401</span>, <span class="attr">message</span>: <span class="string">'Invalid token'</span> &#125;)</span><br><span class="line">  &#125;</span><br><span class="line">  res.send(&#123; <span class="attr">status</span>: <span class="number">500</span>, <span class="attr">message</span>: <span class="string">'Unknown error'</span> &#125;)</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure>
<h1 id="大事件后台-API-项目"><a href="#大事件后台-API-项目" class="headerlink" title="大事件后台 API 项目"></a>大事件后台 API 项目</h1><blockquote>
<p><a href="https://www.showdoc.cc/escook?page_id=3707158761215217" target="_blank" rel="noopener">API 接口文档(opens new window)</a></p>
</blockquote>
<h2 id="1-项目初始化"><a href="#1-项目初始化" class="headerlink" title="1. 项目初始化"></a>1. 项目初始化</h2><h3 id="创建项目"><a href="#创建项目" class="headerlink" title="创建项目"></a>创建项目</h3><p>新建 <code>api_server</code> 文件夹作为项目根目录，并在项目根目录中运行如下的命令，初始化包管理配置文件：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">npm init -y</span><br></pre></td></tr></table></figure>
<p>运行如下的命令，安装特定版本的 <code>express</code>：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">npm i express@4.17.1</span><br></pre></td></tr></table></figure>
<p>在项目根目录中新建 <code>app.js</code> 作为整个项目的入口文件，并初始化如下的代码：</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> express = <span class="built_in">require</span>(<span class="string">'express'</span>)</span><br><span class="line"><span class="comment">// 创建 express 的服务器实例</span></span><br><span class="line"><span class="keyword">const</span> app = express()</span><br><span class="line"></span><br><span class="line"><span class="comment">// write your code here...</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// 调用 app.listen 方法，指定端口号并启动web服务器</span></span><br><span class="line">app.listen(<span class="number">3007</span>, <span class="function"><span class="keyword">function</span> (<span class="params"></span>) </span>&#123;</span><br><span class="line">  <span class="built_in">console</span>.log(<span class="string">'api server running at http://127.0.0.1:3007'</span>)</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure>
<h3 id="配置-cors-跨域"><a href="#配置-cors-跨域" class="headerlink" title="配置 cors 跨域"></a>配置 cors 跨域</h3><p>运行如下的命令，安装 <code>cors</code> 中间件：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">npm i cors@2.8.5</span><br></pre></td></tr></table></figure>
<p>在 <code>app.js</code> 中导入并配置 <code>cors</code> 中间件：</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> cors = <span class="built_in">require</span>(<span class="string">'cors'</span>)</span><br><span class="line"></span><br><span class="line">app.use(cors())</span><br></pre></td></tr></table></figure>
<h3 id="配置解析表单数据的中间件"><a href="#配置解析表单数据的中间件" class="headerlink" title="配置解析表单数据的中间件"></a>配置解析表单数据的中间件</h3><p>通过如下的代码，配置解析 <code>application/x-www-form-urlencoded</code> 格式的表单数据的中间件：</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">app.use(express.urlencoded(&#123; <span class="attr">extended</span>: <span class="literal">false</span> &#125;))</span><br></pre></td></tr></table></figure>
<h3 id="初始化路由相关的文件夹"><a href="#初始化路由相关的文件夹" class="headerlink" title="初始化路由相关的文件夹"></a>初始化路由相关的文件夹</h3><p>在项目根目录中，新建 <code>router</code> 文件夹，用来存放所有的<code>路由</code>模块</p>
<blockquote>
<p>路由模块中，只存放客户端的请求与处理函数之间的映射关系</p>
</blockquote>
<p>在项目根目录中，新建 <code>router_handler</code> 文件夹，用来存放所有的 <code>路由处理函数模块</code></p>
<blockquote>
<p>路由处理函数模块中，专门负责存放每个路由对应的处理函数</p>
</blockquote>
<h3 id="初始化用户路由模块"><a href="#初始化用户路由模块" class="headerlink" title="初始化用户路由模块"></a>初始化用户路由模块</h3><p>在 <code>router</code> 文件夹中，新建 <code>user.js</code> 文件，作为用户的路由模块，并初始化代码：</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> express = <span class="built_in">require</span>(<span class="string">'express'</span>)</span><br><span class="line"><span class="comment">// 创建路由对象</span></span><br><span class="line"><span class="keyword">const</span> router = express.Router()</span><br><span class="line"></span><br><span class="line"><span class="comment">// 注册新用户</span></span><br><span class="line">router.post(<span class="string">'/reguser'</span>, (req, res) =&gt; &#123;</span><br><span class="line">  res.send(<span class="string">'reguser OK'</span>)</span><br><span class="line">&#125;)</span><br><span class="line"></span><br><span class="line"><span class="comment">// 登录</span></span><br><span class="line">router.post(<span class="string">'/login'</span>, (req, res) =&gt; &#123;</span><br><span class="line">  res.send(<span class="string">'login OK'</span>)</span><br><span class="line">&#125;)</span><br><span class="line"></span><br><span class="line"><span class="built_in">module</span>.exports = router</span><br></pre></td></tr></table></figure>
<p>在 <code>app.js</code> 中，导入注册用户路由模块 ：</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> userRouter = <span class="built_in">require</span>(<span class="string">'./router/user'</span>)</span><br><span class="line">app.use(<span class="string">'/api'</span>, userRouter)</span><br></pre></td></tr></table></figure>
<h3 id="抽离用户路由模块中的处理函数"><a href="#抽离用户路由模块中的处理函数" class="headerlink" title="抽离用户路由模块中的处理函数"></a>抽离用户路由模块中的处理函数</h3><blockquote>
<p>目的：为了保证 <code>路由模块</code> 的纯粹性，所有的 <code>路由处理函数</code>，必须抽离到对应的 <code>路由处理函数模块</code> 中</p>
</blockquote>
<p>在 <code>/router_handler/user.js</code> 中，使用 <code>exports</code> 对象，分别向外共享如下两个 <code>路由处理函数</code> ：</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 在这里定义和用户相关的路由处理函数，供 /router/user.js 模块进行调用</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// 注册用户的处理函数</span></span><br><span class="line">exports.regUser = <span class="function">(<span class="params">req, res</span>) =&gt;</span> &#123;</span><br><span class="line">  res.send(<span class="string">'reguser OK'</span>)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 登录的处理函数</span></span><br><span class="line">exports.login = <span class="function">(<span class="params">req, res</span>) =&gt;</span> &#123;</span><br><span class="line">  res.send(<span class="string">'login OK'</span>)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>将 <code>/router/user.js</code> 中的代码修改为如下结构：</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> express = <span class="built_in">require</span>(<span class="string">'express'</span>)</span><br><span class="line"><span class="keyword">const</span> router = express.Router()</span><br><span class="line"></span><br><span class="line"><span class="comment">// 导入用户路由处理函数模块</span></span><br><span class="line"><span class="keyword">const</span> userHandler = <span class="built_in">require</span>(<span class="string">'../router_handler/user'</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment">// 注册新用户</span></span><br><span class="line">router.post(<span class="string">'/reguser'</span>, userHandler.regUser)</span><br><span class="line"><span class="comment">// 登录</span></span><br><span class="line">router.post(<span class="string">'/login'</span>, userHandler.login)</span><br><span class="line"></span><br><span class="line"><span class="built_in">module</span>.exports = router</span><br></pre></td></tr></table></figure>
<h2 id="登录注册"><a href="#登录注册" class="headerlink" title="登录注册"></a>登录注册</h2><h3 id="新建-ev-users-表"><a href="#新建-ev-users-表" class="headerlink" title="新建 ev_users 表"></a>新建 ev_users 表</h3><p>在 <code>test</code> 数据库中，新建 <code>ev_users</code> 表如下：</p>
<p><img src="https://brucecai55520.gitee.io/bruceblog/assets/img/ev_users.77f8cdd3.png" alt="ev_users表结构"></p>
<h3 id="安装并配置-mysql-模块"><a href="#安装并配置-mysql-模块" class="headerlink" title="安装并配置 mysql 模块"></a>安装并配置 mysql 模块</h3><blockquote>
<p>在 API 接口项目中，需要安装并配置 <code>mysql</code> 这个第三方模块，来连接和操作 MySQL 数据库</p>
</blockquote>
<p>运行如下命令，安装 <code>mysql</code> 模块：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">npm i mysql@2.18.1</span><br></pre></td></tr></table></figure>
<p>在项目根目录中新建 <code>/db/index.js</code> 文件，在此自定义模块中创建数据库的连接对象：</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> mysql = <span class="built_in">require</span>(<span class="string">'mysql'</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment">// 创建数据库连接对象</span></span><br><span class="line"><span class="keyword">const</span> db = mysql.createPool(&#123;</span><br><span class="line">  host: <span class="string">'127.0.0.1'</span>,</span><br><span class="line">  user: <span class="string">'root'</span>,</span><br><span class="line">  password: <span class="string">'admin123'</span>,</span><br><span class="line">  database: <span class="string">'my_db_01'</span>,</span><br><span class="line">&#125;)</span><br><span class="line"></span><br><span class="line"><span class="comment">// 向外共享 db 数据库连接对象</span></span><br><span class="line"><span class="built_in">module</span>.exports = db</span><br></pre></td></tr></table></figure>
<h3 id="注册"><a href="#注册" class="headerlink" title="注册"></a>注册</h3><h4 id="实现步骤"><a href="#实现步骤" class="headerlink" title="实现步骤"></a>实现步骤</h4><ol>
<li>检测表单数据是否合法</li>
<li>检测用户名是否被占用</li>
<li>对密码进行加密处理</li>
<li>插入新用户</li>
</ol>
<h4 id="检测表单数据是否合法"><a href="#检测表单数据是否合法" class="headerlink" title="检测表单数据是否合法"></a>检测表单数据是否合法</h4><p>判断用户名和密码是否为空</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 接收表单数据</span></span><br><span class="line"><span class="keyword">const</span> userinfo = req.body</span><br><span class="line"><span class="comment">// 判断数据是否合法</span></span><br><span class="line"><span class="keyword">if</span> (!userinfo.username || !userinfo.password) &#123;</span><br><span class="line">  <span class="keyword">return</span> res.send(&#123; <span class="attr">status</span>: <span class="number">1</span>, <span class="attr">message</span>: <span class="string">'用户名或密码不能为空！'</span> &#125;)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="检测用户名是否被占用"><a href="#检测用户名是否被占用" class="headerlink" title="检测用户名是否被占用"></a>检测用户名是否被占用</h4><p>导入数据库操作模块：</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> db = <span class="built_in">require</span>(<span class="string">'../db/index'</span>)</span><br></pre></td></tr></table></figure>
<p>定义 SQL 语句：</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> sql = <span class="string">`select * from ev_users where username=?`</span></span><br></pre></td></tr></table></figure>
<p>执行 SQL 语句并根据结果判断用户名是否被占用：</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">db.query(sql, [userinfo.username], <span class="function"><span class="keyword">function</span> (<span class="params">err, results</span>) </span>&#123;</span><br><span class="line">  <span class="comment">// 执行 SQL 语句失败</span></span><br><span class="line">  <span class="keyword">if</span> (err) &#123;</span><br><span class="line">    <span class="keyword">return</span> res.send(&#123; <span class="attr">status</span>: <span class="number">1</span>, <span class="attr">message</span>: err.message &#125;)</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="comment">// 用户名被占用</span></span><br><span class="line">  <span class="keyword">if</span> (results.length &gt; <span class="number">0</span>) &#123;</span><br><span class="line">    <span class="keyword">return</span> res.send(&#123; <span class="attr">status</span>: <span class="number">1</span>, <span class="attr">message</span>: <span class="string">'用户名被占用，请更换其他用户名！'</span> &#125;)</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="comment">// <span class="doctag">TODO:</span> 用户名可用，继续后续流程...</span></span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure>
<h4 id="对密码进行加密处理"><a href="#对密码进行加密处理" class="headerlink" title="对密码进行加密处理"></a>对密码进行加密处理</h4><blockquote>
<p>为了保证密码的安全性，不建议在数据库以 <code>明文</code> 的形式保存用户密码，推荐对密码进行 <code>加密存储</code></p>
</blockquote>
<hr>
<p>在当前项目中，使用 <code>bcryptjs</code> 对用户密码进行加密，优点：</p>
<ul>
<li>加密之后的密码，<strong>无法被逆向破解</strong></li>
<li>同一明文密码多次加密，得到的<strong>加密结果各不相同</strong>，保证了安全性</li>
</ul>
<hr>
<p>运行如下命令，安装指定版本的 <code>bcryptjs</code> ：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">npm i bcryptjs@2.4.3</span><br></pre></td></tr></table></figure>
<p>在 <code>/router_handler/user.js</code> 中，导入 <code>bcryptjs</code> ：</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> bcrypt = <span class="built_in">require</span>(<span class="string">'bcryptjs'</span>)</span><br></pre></td></tr></table></figure>
<p>在注册用户的处理函数中，确认用户名可用之后，调用 <code>bcrypt.hashSync(明文密码, 随机盐的长度)</code> 方法，对用户的密码进行加密处理：</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 对用户的密码,进行 bcrype 加密，返回值是加密之后的密码字符串</span></span><br><span class="line">userinfo.password = bcrypt.hashSync(userinfo.password, <span class="number">10</span>)</span><br></pre></td></tr></table></figure>
<h4 id="插入新用户"><a href="#插入新用户" class="headerlink" title="插入新用户"></a>插入新用户</h4><p>定义插入用户的 SQL 语句：</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> sql = <span class="string">'insert into ev_users set ?'</span></span><br></pre></td></tr></table></figure>
<p>调用 <code>db.query()</code> 执行 SQL 语句，插入新用户：</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">db.query(sql, &#123; <span class="attr">username</span>: userinfo.username, <span class="attr">password</span>: userinfo.password &#125;, <span class="function"><span class="keyword">function</span> (<span class="params">err, results</span>) </span>&#123;</span><br><span class="line">  <span class="comment">// 执行 SQL 语句失败</span></span><br><span class="line">  <span class="keyword">if</span> (err) <span class="keyword">return</span> res.send(&#123; <span class="attr">status</span>: <span class="number">1</span>, <span class="attr">message</span>: err.message &#125;)</span><br><span class="line">  <span class="comment">// SQL 语句执行成功，但影响行数不为 1</span></span><br><span class="line">  <span class="keyword">if</span> (results.affectedRows !== <span class="number">1</span>) &#123;</span><br><span class="line">    <span class="keyword">return</span> res.send(&#123; <span class="attr">status</span>: <span class="number">1</span>, <span class="attr">message</span>: <span class="string">'注册用户失败，请稍后再试！'</span> &#125;)</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="comment">// 注册成功</span></span><br><span class="line">  res.send(&#123; <span class="attr">status</span>: <span class="number">0</span>, <span class="attr">message</span>: <span class="string">'注册成功！'</span> &#125;)</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure>
<h3 id="优化-res-send-代码"><a href="#优化-res-send-代码" class="headerlink" title="优化 res.send() 代码"></a>优化 res.send() 代码</h3><blockquote>
<p>在处理函数中，需要多次调用 <code>res.send()</code> 向客户端响应 <code>处理失败</code> 的结果，为了简化代码，可以手动封装一个 res.cc() 函数</p>
</blockquote>
<p>在 <code>app.js</code> 中，所有路由之前，声明一个全局中间件，为 res 对象挂载一个 <code>res.cc()</code> 函数 ：</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 响应数据的中间件</span></span><br><span class="line">app.use(<span class="function"><span class="keyword">function</span> (<span class="params">req, res, next</span>) </span>&#123;</span><br><span class="line">  <span class="comment">// status = 0 为成功； status = 1 为失败； 默认将 status 的值设置为 1，方便处理失败的情况</span></span><br><span class="line">  res.cc = <span class="function"><span class="keyword">function</span> (<span class="params">err, status = <span class="number">1</span></span>) </span>&#123;</span><br><span class="line">    res.send(&#123;</span><br><span class="line">      <span class="comment">// 状态</span></span><br><span class="line">      status,</span><br><span class="line">      <span class="comment">// 状态描述，判断 err 是 错误对象 还是 字符串</span></span><br><span class="line">      message: err <span class="keyword">instanceof</span> <span class="built_in">Error</span> ? err.message : err,</span><br><span class="line">    &#125;)</span><br><span class="line">  &#125;</span><br><span class="line">  next()</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure>
<h3 id="优化表单数据验证"><a href="#优化表单数据验证" class="headerlink" title="优化表单数据验证"></a>优化表单数据验证</h3><blockquote>
<p>表单验证的原则：前端验证为辅，后端验证为主，后端<strong>永远不要相信</strong>前端提交过来的<strong>任何内容</strong></p>
</blockquote>
<p>在实际开发中，前后端都需要对表单的数据进行合法性的验证，而且，<strong>后端做为数据合法性验证的最后一个关口</strong>，在拦截非法数据方面，起到了至关重要的作用。</p>
<p>单纯的使用 <code>if...else...</code> 的形式对数据合法性进行验证，效率低下、出错率高、维护性差。因此，推荐使用<strong>第三方数据验证模块</strong>，来降低出错率、提高验证的效率与可维护性，<strong>让后端程序员把更多的精力放在核心业务逻辑的处理上</strong>。</p>
<p>安装 <code>joi</code> 包，为表单中携带的每个数据项，定义验证规则：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">npm install joi</span><br></pre></td></tr></table></figure>
<p>安装 <code>@escook/express-joi</code> 中间件，来实现自动对表单数据进行验证的功能：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">npm i @escook/express-joi</span><br></pre></td></tr></table></figure>
<p>新建 <code>/schema/user.js</code> 用户信息验证规则模块，并初始化代码如下：</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> joi = <span class="built_in">require</span>(<span class="string">'joi'</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * string() 值必须是字符串</span></span><br><span class="line"><span class="comment"> * alphanum() 值只能是包含 a-zA-Z0-9 的字符串</span></span><br><span class="line"><span class="comment"> * min(length) 最小长度</span></span><br><span class="line"><span class="comment"> * max(length) 最大长度</span></span><br><span class="line"><span class="comment"> * required() 值是必填项，不能为 undefined</span></span><br><span class="line"><span class="comment"> * pattern(正则表达式) 值必须符合正则表达式的规则</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// 用户名的验证规则</span></span><br><span class="line"><span class="keyword">const</span> username = joi.string().alphanum().min(<span class="number">1</span>).max(<span class="number">10</span>).required()</span><br><span class="line"><span class="comment">// 密码的验证规则</span></span><br><span class="line"><span class="keyword">const</span> password = joi</span><br><span class="line">  .string()</span><br><span class="line">  .pattern(<span class="regexp">/^[\S]&#123;6,12&#125;$/</span>)</span><br><span class="line">  .required()</span><br><span class="line"></span><br><span class="line"><span class="comment">// 注册和登录表单的验证规则对象</span></span><br><span class="line">exports.reg_login_schema = &#123;</span><br><span class="line">  <span class="comment">// 表示需要对 req.body 中的数据进行验证</span></span><br><span class="line">  body: &#123;</span><br><span class="line">    username,</span><br><span class="line">    password,</span><br><span class="line">  &#125;,</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>修改 <code>/router/user.js</code> 中的代码如下：</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> express = <span class="built_in">require</span>(<span class="string">'express'</span>)</span><br><span class="line"><span class="keyword">const</span> router = express.Router()</span><br><span class="line"></span><br><span class="line"><span class="comment">// 导入用户路由处理函数模块</span></span><br><span class="line"><span class="keyword">const</span> userHandler = <span class="built_in">require</span>(<span class="string">'../router_handler/user'</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment">// 1. 导入验证表单数据的中间件</span></span><br><span class="line"><span class="keyword">const</span> expressJoi = <span class="built_in">require</span>(<span class="string">'@escook/express-joi'</span>)</span><br><span class="line"><span class="comment">// 2. 导入需要的验证规则对象</span></span><br><span class="line"><span class="keyword">const</span> &#123; reg_login_schema &#125; = <span class="built_in">require</span>(<span class="string">'../schema/user'</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment">// 注册新用户</span></span><br><span class="line"><span class="comment">// 3. 在注册新用户的路由中，声明局部中间件，对当前请求中携带的数据进行验证</span></span><br><span class="line"><span class="comment">// 3.1 数据验证通过后，会把这次请求流转给后面的路由处理函数</span></span><br><span class="line"><span class="comment">// 3.2 数据验证失败后，终止后续代码的执行，并抛出一个全局的 Error 错误，进入全局错误级别中间件中进行处理</span></span><br><span class="line">router.post(<span class="string">'/reguser'</span>, expressJoi(reg_login_schema), userHandler.regUser)</span><br><span class="line"><span class="comment">// 登录</span></span><br><span class="line">router.post(<span class="string">'/login'</span>, userHandler.login)</span><br><span class="line"></span><br><span class="line"><span class="built_in">module</span>.exports = router</span><br></pre></td></tr></table></figure>
<p>在 <code>app.js</code> 的全局错误级别中间件中，捕获验证失败的错误，并把验证失败的结果响应给客户端：</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> joi = <span class="built_in">require</span>(<span class="string">'joi'</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment">// 错误中间件</span></span><br><span class="line">app.use(<span class="function"><span class="keyword">function</span> (<span class="params">err, req, res, next</span>) </span>&#123;</span><br><span class="line">  <span class="comment">// 数据验证失败</span></span><br><span class="line">  <span class="keyword">if</span> (err <span class="keyword">instanceof</span> joi.ValidationError) <span class="keyword">return</span> res.cc(err)</span><br><span class="line">  <span class="comment">// 未知错误</span></span><br><span class="line">  res.cc(err)</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure>
<h3 id="登录"><a href="#登录" class="headerlink" title="登录"></a>登录</h3><h4 id="实现步骤-1"><a href="#实现步骤-1" class="headerlink" title="实现步骤"></a>实现步骤</h4><ol>
<li>检测表单数据是否合法</li>
<li>根据用户名查询用户的数据</li>
<li>判断用户输入的密码是否正确</li>
<li>生成 JWT 的 Token 字符串</li>
</ol>
<h4 id="检测登录表单的数据是否合法"><a href="#检测登录表单的数据是否合法" class="headerlink" title="检测登录表单的数据是否合法"></a>检测登录表单的数据是否合法</h4><p>将 <code>/router/user.js</code> 中 <code>登录</code> 的路由代码修改如下：</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 登录的路由</span></span><br><span class="line">router.post(<span class="string">'/login'</span>, expressJoi(reg_login_schema), userHandler.login)</span><br></pre></td></tr></table></figure>
<h4 id="根据用户名查询用户的数据"><a href="#根据用户名查询用户的数据" class="headerlink" title="根据用户名查询用户的数据"></a>根据用户名查询用户的数据</h4><p>接收表单数据：</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> userinfo = req.body</span><br></pre></td></tr></table></figure>
<p>定义 SQL 语句：</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> sql = <span class="string">`select * from ev_users where username=?`</span></span><br></pre></td></tr></table></figure>
<p>执行 SQL 语句，查询用户的数据：</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">db.query(sql, userinfo.username, <span class="function"><span class="keyword">function</span> (<span class="params">err, results</span>) </span>&#123;</span><br><span class="line">  <span class="comment">// 执行 SQL 语句失败</span></span><br><span class="line">  <span class="keyword">if</span> (err) <span class="keyword">return</span> res.cc(err)</span><br><span class="line">  <span class="comment">// 执行 SQL 语句成功，但是查询到数据条数不等于 1</span></span><br><span class="line">  <span class="keyword">if</span> (results.length !== <span class="number">1</span>) <span class="keyword">return</span> res.cc(<span class="string">'登录失败！'</span>)</span><br><span class="line">  <span class="comment">// TODO：判断用户输入的登录密码是否和数据库中的密码一致</span></span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure>
<h4 id="判断用户输入的密码是否正确"><a href="#判断用户输入的密码是否正确" class="headerlink" title="判断用户输入的密码是否正确"></a>判断用户输入的密码是否正确</h4><blockquote>
<p>核心实现思路：调用 <code>bcrypt.compareSync(用户提交的密码, 数据库中的密码)</code> 方法比较密码是否一致</p>
</blockquote>
<blockquote>
<p>返回值是布尔值（true 一致、false 不一致）</p>
</blockquote>
<p>具体的实现代码如下：</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 拿着用户输入的密码,和数据库中存储的密码进行对比</span></span><br><span class="line"><span class="keyword">const</span> compareResult = bcrypt.compareSync(userinfo.password, results[<span class="number">0</span>].password)</span><br><span class="line"></span><br><span class="line"><span class="comment">// 如果对比的结果等于 false, 则证明用户输入的密码错误</span></span><br><span class="line"><span class="keyword">if</span> (!compareResult) &#123;</span><br><span class="line">  <span class="keyword">return</span> res.cc(<span class="string">'登录失败！'</span>)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// TODO：登录成功，生成 Token 字符串</span></span><br></pre></td></tr></table></figure>
<h4 id="生成-JWT-的-Token-字符串"><a href="#生成-JWT-的-Token-字符串" class="headerlink" title="生成 JWT 的 Token 字符串"></a>生成 JWT 的 Token 字符串</h4><blockquote>
<p>核心注意点：在生成 Token 字符串的时候，一定要剔除 <strong>密码</strong> 和 <strong>头像</strong> 的值</p>
</blockquote>
<p>通过 ES6 的高级语法，快速剔除 <code>密码</code> 和 <code>头像</code> 的值：</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 剔除完毕之后，user 中只保留了用户的 id, username, nickname, email 这四个属性的值</span></span><br><span class="line"><span class="keyword">const</span> user = &#123; ...results[<span class="number">0</span>], <span class="attr">password</span>: <span class="string">''</span>, <span class="attr">user_pic</span>: <span class="string">''</span> &#125;</span><br></pre></td></tr></table></figure>
<p>运行如下的命令，安装生成 Token 字符串的包：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">npm i jsonwebtoken@8.5.1</span><br></pre></td></tr></table></figure>
<p>在 <code>/router_handler/user.js</code> 模块的头部区域，导入 <code>jsonwebtoken</code> 包：</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 用这个包来生成 Token 字符串</span></span><br><span class="line"><span class="keyword">const</span> jwt = <span class="built_in">require</span>(<span class="string">'jsonwebtoken'</span>)</span><br></pre></td></tr></table></figure>
<p>创建 <code>config.js</code> 文件，并向外共享 <strong>加密</strong> 和 <strong>还原</strong> Token 的 <code>jwtSecretKey</code> 字符串：</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">module</span>.exports = &#123;</span><br><span class="line">  jwtSecretKey: <span class="string">'Bruce'</span>,</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>将用户信息对象加密成 Token 字符串：</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 导入配置文件</span></span><br><span class="line"><span class="keyword">const</span> config = <span class="built_in">require</span>(<span class="string">'../config'</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment">// 生成 Token 字符串</span></span><br><span class="line"><span class="keyword">const</span> tokenStr = jwt.sign(user, config.jwtSecretKey, &#123;</span><br><span class="line">  expiresIn: <span class="string">'10h'</span>, <span class="comment">// token 有效期为 10 个小时</span></span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure>
<p>将生成的 Token 字符串响应给客户端：</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">res.send(&#123;</span><br><span class="line">  status: <span class="number">0</span>,</span><br><span class="line">  message: <span class="string">'登录成功！'</span>,</span><br><span class="line">  <span class="comment">// 为了方便客户端使用 Token，在服务器端直接拼接上 Bearer 的前缀</span></span><br><span class="line">  token: <span class="string">'Bearer '</span> + tokenStr,</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure>
<h3 id="配置解析-Token-的中间件"><a href="#配置解析-Token-的中间件" class="headerlink" title="配置解析 Token 的中间件"></a>配置解析 Token 的中间件</h3><p>运行如下的命令，安装解析 Token 的中间件：</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">npm i express-jwt@<span class="number">5.3</span><span class="number">.3</span></span><br></pre></td></tr></table></figure>
<p>在 <code>app.js</code> 中注册路由之前，配置解析 Token 的中间件：</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 导入配置文件</span></span><br><span class="line"><span class="keyword">const</span> config = <span class="built_in">require</span>(<span class="string">'./config'</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment">// 解析 token 的中间件</span></span><br><span class="line"><span class="keyword">const</span> expressJWT = <span class="built_in">require</span>(<span class="string">'express-jwt'</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment">// 使用 .unless(&#123; path: [/^\/api\//] &#125;) 指定哪些接口不需要进行 Token 的身份认证</span></span><br><span class="line">app.use(expressJWT(&#123; <span class="attr">secret</span>: config.jwtSecretKey &#125;).unless(&#123; <span class="attr">path</span>: [<span class="regexp">/^\/api\//</span>] &#125;))</span><br></pre></td></tr></table></figure>
<p>在 <code>app.js</code> 中的 <code>错误级别中间件</code> 里面，捕获并处理 Token 认证失败后的错误：</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 错误中间件</span></span><br><span class="line">app.use(<span class="function"><span class="keyword">function</span> (<span class="params">err, req, res, next</span>) </span>&#123;</span><br><span class="line">  <span class="comment">// 省略其它代码...</span></span><br><span class="line"></span><br><span class="line">  <span class="comment">// 捕获身份认证失败的错误</span></span><br><span class="line">  <span class="keyword">if</span> (err.name === <span class="string">'UnauthorizedError'</span>) <span class="keyword">return</span> res.cc(<span class="string">'身份认证失败！'</span>)</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 未知错误...</span></span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure>
<h2 id="个人中心"><a href="#个人中心" class="headerlink" title="个人中心"></a>个人中心</h2><h3 id="获取用户的基本信息"><a href="#获取用户的基本信息" class="headerlink" title="获取用户的基本信息"></a>获取用户的基本信息</h3><h4 id="实现步骤-2"><a href="#实现步骤-2" class="headerlink" title="实现步骤"></a>实现步骤</h4><ol>
<li>初始化 <strong>路由</strong> 模块</li>
<li>初始化 <strong>路由处理函数</strong> 模块</li>
<li>获取用户的基本信息</li>
</ol>
<h4 id="初始化路由模块"><a href="#初始化路由模块" class="headerlink" title="初始化路由模块"></a>初始化路由模块</h4><p>创建 <code>/router/userinfo.js</code> 路由模块，并初始化如下的代码结构：</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 导入 express</span></span><br><span class="line"><span class="keyword">const</span> express = <span class="built_in">require</span>(<span class="string">'express'</span>)</span><br><span class="line"><span class="comment">// 创建路由对象</span></span><br><span class="line"><span class="keyword">const</span> router = express.Router()</span><br><span class="line"></span><br><span class="line"><span class="comment">// 获取用户的基本信息</span></span><br><span class="line">router.get(<span class="string">'/userinfo'</span>, (req, res) =&gt; &#123;</span><br><span class="line">  res.send(<span class="string">'ok'</span>)</span><br><span class="line">&#125;)</span><br><span class="line"></span><br><span class="line"><span class="comment">// 向外共享路由对象</span></span><br><span class="line"><span class="built_in">module</span>.exports = router</span><br></pre></td></tr></table></figure>
<p>在 <code>app.js</code> 中导入并使用个人中心的路由模块：</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 导入并使用用户信息路由模块</span></span><br><span class="line"><span class="keyword">const</span> userinfoRouter = <span class="built_in">require</span>(<span class="string">'./router/userinfo'</span>)</span><br><span class="line"><span class="comment">// 注意：以 /my 开头的接口，都是有权限的接口，需要进行 Token 身份认证</span></span><br><span class="line">app.use(<span class="string">'/my'</span>, userinfoRouter)</span><br></pre></td></tr></table></figure>
<h4 id="初始化路由处理函数模块"><a href="#初始化路由处理函数模块" class="headerlink" title="初始化路由处理函数模块"></a>初始化路由处理函数模块</h4><p>创建 <code>/router_handler/userinfo.js</code> 路由处理函数模块，并初始化如下的代码结构：</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 获取用户基本信息的处理函数</span></span><br><span class="line">exports.getUserInfo = <span class="function">(<span class="params">req, res</span>) =&gt;</span> &#123;</span><br><span class="line">  res.send(<span class="string">'ok'</span>)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>修改 <code>/router/userinfo.js</code> 中的代码如下：</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> express = <span class="built_in">require</span>(<span class="string">'express'</span>)</span><br><span class="line"><span class="keyword">const</span> router = express.Router()</span><br><span class="line"></span><br><span class="line"><span class="comment">// 导入用户信息的处理函数模块</span></span><br><span class="line"><span class="keyword">const</span> userinfo_handler = <span class="built_in">require</span>(<span class="string">'../router_handler/userinfo'</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment">// 获取用户的基本信息</span></span><br><span class="line">router.get(<span class="string">'/userinfo'</span>, userinfo_handler.getUserInfo)</span><br><span class="line"></span><br><span class="line"><span class="built_in">module</span>.exports = router</span><br></pre></td></tr></table></figure>
<h4 id="获取用户的基本信息-1"><a href="#获取用户的基本信息-1" class="headerlink" title="获取用户的基本信息"></a>获取用户的基本信息</h4><p>在 <code>/router_handler/userinfo.js</code> 头部导入数据库操作模块：</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 导入数据库操作模块</span></span><br><span class="line"><span class="keyword">const</span> db = <span class="built_in">require</span>(<span class="string">'../db/index'</span>)</span><br></pre></td></tr></table></figure>
<p>定义 SQL 语句：</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 根据用户的 id，查询用户的基本信息</span></span><br><span class="line"><span class="comment">// 注意：为了防止用户的密码泄露，需要排除 password 字段</span></span><br><span class="line"><span class="keyword">const</span> sql = <span class="string">`select id, username, nickname, email, user_pic from ev_users where id=?`</span></span><br></pre></td></tr></table></figure>
<p>调用 <code>db.query()</code> 执行 SQL 语句：</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 注意：req 对象上的 user 属性，是 Token 解析成功，express-jwt 中间件帮我们挂载上去的</span></span><br><span class="line">db.query(sql, req.user.id, (err, results) =&gt; &#123;</span><br><span class="line">  <span class="comment">// 1. 执行 SQL 语句失败</span></span><br><span class="line">  <span class="keyword">if</span> (err) <span class="keyword">return</span> res.cc(err)</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 2. 执行 SQL 语句成功，但是查询到的数据条数不等于 1</span></span><br><span class="line">  <span class="keyword">if</span> (results.length !== <span class="number">1</span>) <span class="keyword">return</span> res.cc(<span class="string">'获取用户信息失败！'</span>)</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 3. 将用户信息响应给客户端</span></span><br><span class="line">  res.send(&#123;</span><br><span class="line">    status: <span class="number">0</span>,</span><br><span class="line">    message: <span class="string">'获取用户基本信息成功！'</span>,</span><br><span class="line">    data: results[<span class="number">0</span>],</span><br><span class="line">  &#125;)</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure>
<h3 id="更新用户的基本信息"><a href="#更新用户的基本信息" class="headerlink" title="更新用户的基本信息"></a>更新用户的基本信息</h3><h4 id="实现步骤-3"><a href="#实现步骤-3" class="headerlink" title="实现步骤"></a>实现步骤</h4><ol>
<li>定义路由和处理函数</li>
<li>验证表单数据</li>
<li>实现更新用户基本信息的功能</li>
</ol>
<h4 id="定义路由和处理函数"><a href="#定义路由和处理函数" class="headerlink" title="定义路由和处理函数"></a>定义路由和处理函数</h4><p>在 <code>/router/userinfo.js</code> 模块中，新增 <code>更新用户基本信息</code> 的路由：</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 更新用户的基本信息</span></span><br><span class="line">router.post(<span class="string">'/userinfo'</span>, userinfo_handler.updateUserInfo)</span><br></pre></td></tr></table></figure>
<p>在 <code>/router_handler/userinfo.js</code> 模块中，定义并向外共享 <code>更新用户基本信息</code> 的路由处理函数：</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 更新用户基本信息的处理函数</span></span><br><span class="line">exports.updateUserInfo = <span class="function">(<span class="params">req, res</span>) =&gt;</span> &#123;</span><br><span class="line">  res.send(<span class="string">'ok'</span>)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="验证表单数据"><a href="#验证表单数据" class="headerlink" title="验证表单数据"></a>验证表单数据</h4><p>在 <code>/schema/user.js</code> 验证规则模块中，定义 <code>id</code>，<code>nickname</code>，<code>email</code> 的验证规则如下：</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 定义 id, nickname, emial 的验证规则</span></span><br><span class="line"><span class="keyword">const</span> id = joi.number().integer().min(<span class="number">1</span>).required()</span><br><span class="line"><span class="keyword">const</span> nickname = joi.string().required()</span><br><span class="line"><span class="keyword">const</span> email = joi.string().email().required()</span><br></pre></td></tr></table></figure>
<p>并使用 <code>exports</code> 向外共享如下的 <code>验证规则对象</code>：</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 验证规则对象 - 更新用户基本信息</span></span><br><span class="line">exports.update_userinfo_schema = &#123;</span><br><span class="line">  body: &#123;</span><br><span class="line">    id,</span><br><span class="line">    nickname,</span><br><span class="line">    email,</span><br><span class="line">  &#125;,</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>在 <code>/router/userinfo.js</code> 模块中，导入验证数据合法性的中间件：</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 导入验证数据合法性的中间件</span></span><br><span class="line"><span class="keyword">const</span> expressJoi = <span class="built_in">require</span>(<span class="string">'@escook/express-joi'</span>)</span><br></pre></td></tr></table></figure>
<p>在 <code>/router/userinfo.js</code> 模块中，导入需要的验证规则对象：</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 导入需要的验证规则对象</span></span><br><span class="line"><span class="keyword">const</span> &#123; update_userinfo_schema &#125; = <span class="built_in">require</span>(<span class="string">'../schema/user'</span>)</span><br></pre></td></tr></table></figure>
<p>在 <code>/router/userinfo.js</code> 模块中，修改 <code>更新用户的基本信息</code> 的路由如下：</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 更新用户的基本信息</span></span><br><span class="line">router.post(<span class="string">'/userinfo'</span>, expressJoi(update_userinfo_schema), userinfo_handler.updateUserInfo)</span><br></pre></td></tr></table></figure>
<h4 id="实现更新用户基本信息的功能"><a href="#实现更新用户基本信息的功能" class="headerlink" title="实现更新用户基本信息的功能"></a>实现更新用户基本信息的功能</h4><p>定义待执行的 SQL 语句：</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> sql = <span class="string">`update ev_users set ? where id=?`</span></span><br></pre></td></tr></table></figure>
<p>调用 <code>db.query()</code> 执行 SQL 语句并传参：</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">db.query(sql, [req.body, req.body.id], (err, results) =&gt; &#123;</span><br><span class="line">  <span class="comment">// 执行 SQL 语句失败</span></span><br><span class="line">  <span class="keyword">if</span> (err) <span class="keyword">return</span> res.cc(err)</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 执行 SQL 语句成功，但影响行数不为 1</span></span><br><span class="line">  <span class="keyword">if</span> (results.affectedRows !== <span class="number">1</span>) <span class="keyword">return</span> res.cc(<span class="string">'修改用户基本信息失败！'</span>)</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 修改用户信息成功</span></span><br><span class="line">  <span class="keyword">return</span> res.cc(<span class="string">'修改用户基本信息成功！'</span>, <span class="number">0</span>)</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure>
<h3 id="重置密码"><a href="#重置密码" class="headerlink" title="重置密码"></a>重置密码</h3><h4 id="实现步骤-4"><a href="#实现步骤-4" class="headerlink" title="实现步骤"></a>实现步骤</h4><ol>
<li>定义路由和处理函数</li>
<li>验证表单数据</li>
<li>实现重置密码的功能</li>
</ol>
<h4 id="定义路由和处理函数-1"><a href="#定义路由和处理函数-1" class="headerlink" title="定义路由和处理函数"></a>定义路由和处理函数</h4><p>在 <code>/router/userinfo.js</code> 模块中，新增 <code>重置密码</code> 的路由：</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 重置密码的路由</span></span><br><span class="line">router.post(<span class="string">'/updatepwd'</span>, userinfo_handler.updatePassword)</span><br></pre></td></tr></table></figure>
<p>在 <code>/router_handler/userinfo.js</code> 模块中，定义并向外共享 <code>重置密码</code> 的路由处理函数：</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 重置密码的处理函数</span></span><br><span class="line">exports.updatePassword = <span class="function">(<span class="params">req, res</span>) =&gt;</span> &#123;</span><br><span class="line">  res.send(<span class="string">'ok'</span>)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="验证表单数据-1"><a href="#验证表单数据-1" class="headerlink" title="验证表单数据"></a>验证表单数据</h4><blockquote>
<p>核心验证思路：旧密码与新密码，必须符合密码的验证规则，并且新密码不能与旧密码一致！</p>
</blockquote>
<p>在 <code>/schema/user.js</code> 模块中，使用 <code>exports</code> 向外共享如下的 <code>验证规则对象</code>：</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 验证规则对象 - 重置密码</span></span><br><span class="line">exports.update_password_schema = &#123;</span><br><span class="line">  body: &#123;</span><br><span class="line">    <span class="comment">// 使用 password 这个规则，验证 req.body.oldPwd 的值</span></span><br><span class="line">    oldPwd: password,</span><br><span class="line">    <span class="comment">// 使用 joi.not(joi.ref('oldPwd')).concat(password) 规则，验证 req.body.newPwd 的值</span></span><br><span class="line">    <span class="comment">// 解读：</span></span><br><span class="line">    <span class="comment">// 1. joi.ref('oldPwd') 表示 newPwd 的值必须和 oldPwd 的值保持一致</span></span><br><span class="line">    <span class="comment">// 2. joi.not(joi.ref('oldPwd')) 表示 newPwd 的值不能等于 oldPwd 的值</span></span><br><span class="line">    <span class="comment">// 3. .concat() 用于合并 joi.not(joi.ref('oldPwd')) 和 password 这两条验证规则</span></span><br><span class="line">    newPwd: joi.not(joi.ref(<span class="string">'oldPwd'</span>)).concat(password),</span><br><span class="line">  &#125;,</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>在 <code>/router/userinfo.js</code> 模块中，导入需要的验证规则对象：</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 导入需要的验证规则对象</span></span><br><span class="line"><span class="keyword">const</span> &#123; update_userinfo_schema, update_password_schema &#125; = <span class="built_in">require</span>(<span class="string">'../schema/user'</span>)</span><br></pre></td></tr></table></figure>
<p>并在 <code>重置密码的路由</code> 中，使用 <code>update_password_schema</code> 规则验证表单的数据，示例代码如下：</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">router.post(<span class="string">'/updatepwd'</span>, expressJoi(update_password_schema), userinfo_handler.updatePassword)</span><br></pre></td></tr></table></figure>
<h4 id="实现重置密码的功能"><a href="#实现重置密码的功能" class="headerlink" title="实现重置密码的功能"></a>实现重置密码的功能</h4><p>根据 <code>id</code> 查询用户是否存在：</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 定义根据 id 查询用户数据的 SQL 语句</span></span><br><span class="line"><span class="keyword">const</span> sql = <span class="string">`select * from ev_users where id=?`</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// 执行 SQL 语句查询用户是否存在</span></span><br><span class="line">db.query(sql, req.user.id, (err, results) =&gt; &#123;</span><br><span class="line">  <span class="comment">// 执行 SQL 语句失败</span></span><br><span class="line">  <span class="keyword">if</span> (err) <span class="keyword">return</span> res.cc(err)</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 检查指定 id 的用户是否存在</span></span><br><span class="line">  <span class="keyword">if</span> (results.length !== <span class="number">1</span>) <span class="keyword">return</span> res.cc(<span class="string">'用户不存在！'</span>)</span><br><span class="line"></span><br><span class="line">  <span class="comment">// TODO：判断提交的旧密码是否正确</span></span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure>
<p>判断提交的 <strong>旧密码</strong> 是否正确：</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 在头部区域导入 bcryptjs 后，</span></span><br><span class="line"><span class="comment">// 即可使用 bcrypt.compareSync(提交的密码，数据库中的密码) 方法验证密码是否正确</span></span><br><span class="line"><span class="comment">// compareSync() 函数的返回值为布尔值，true 表示密码正确，false 表示密码错误</span></span><br><span class="line"><span class="keyword">const</span> bcrypt = <span class="built_in">require</span>(<span class="string">'bcryptjs'</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment">// 判断提交的旧密码是否正确</span></span><br><span class="line"><span class="keyword">const</span> compareResult = bcrypt.compareSync(req.body.oldPwd, results[<span class="number">0</span>].password)</span><br><span class="line"><span class="keyword">if</span> (!compareResult) <span class="keyword">return</span> res.cc(<span class="string">'原密码错误！'</span>)</span><br></pre></td></tr></table></figure>
<p>对新密码进行 <code>bcrypt</code> 加密之后，更新到数据库中：</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 定义更新用户密码的 SQL 语句</span></span><br><span class="line"><span class="keyword">const</span> sql = <span class="string">`update ev_users set password=? where id=?`</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// 对新密码进行 bcrypt 加密处理</span></span><br><span class="line"><span class="keyword">const</span> newPwd = bcrypt.hashSync(req.body.newPwd, <span class="number">10</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment">// 执行 SQL 语句，根据 id 更新用户的密码</span></span><br><span class="line">db.query(sql, [newPwd, req.user.id], (err, results) =&gt; &#123;</span><br><span class="line">  <span class="comment">// SQL 语句执行失败</span></span><br><span class="line">  <span class="keyword">if</span> (err) <span class="keyword">return</span> res.cc(err)</span><br><span class="line"></span><br><span class="line">  <span class="comment">// SQL 语句执行成功，但是影响行数不等于 1</span></span><br><span class="line">  <span class="keyword">if</span> (results.affectedRows !== <span class="number">1</span>) <span class="keyword">return</span> res.cc(<span class="string">'更新密码失败！'</span>)</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 更新密码成功</span></span><br><span class="line">  res.cc(<span class="string">'更新密码成功！'</span>, <span class="number">0</span>)</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure>
<h3 id="更新用户头像"><a href="#更新用户头像" class="headerlink" title="更新用户头像"></a>更新用户头像</h3><h4 id="实现步骤-5"><a href="#实现步骤-5" class="headerlink" title="实现步骤"></a>实现步骤</h4><ol>
<li>定义路由和处理函数</li>
<li>验证表单数据</li>
<li>实现更新用户头像的功能</li>
</ol>
<h4 id="定义路由和处理函数-2"><a href="#定义路由和处理函数-2" class="headerlink" title="定义路由和处理函数"></a>定义路由和处理函数</h4><p>在 <code>/router/userinfo.js</code> 模块中，新增 <code>更新用户头像</code> 的路由：</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 更新用户头像的路由</span></span><br><span class="line">router.post(<span class="string">'/update/avatar'</span>, userinfo_handler.updateAvatar)</span><br></pre></td></tr></table></figure>
<p>在 <code>/router_handler/userinfo.js</code> 模块中，定义并向外共享 <code>更新用户头像</code> 的路由处理函数：</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 更新用户头像的处理函数</span></span><br><span class="line">exports.updateAvatar = <span class="function">(<span class="params">req, res</span>) =&gt;</span> &#123;</span><br><span class="line">  res.send(<span class="string">'ok'</span>)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="验证表单数据-2"><a href="#验证表单数据-2" class="headerlink" title="验证表单数据"></a>验证表单数据</h4><p>在 <code>/schema/user.js</code> 验证规则模块中，定义 <code>avatar</code> 的验证规则如下：</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// dataUri() 指的是如下格式的字符串数据：</span></span><br><span class="line"><span class="comment">// data:image/png;base64,VE9PTUFOWVNFQ1JFVFM=</span></span><br><span class="line"><span class="keyword">const</span> avatar = joi.string().dataUri().required()</span><br></pre></td></tr></table></figure>
<p>并使用 <code>exports</code> 向外共享如下的 <code>验证规则对象</code>：</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 验证规则对象 - 更新头像</span></span><br><span class="line">exports.update_avatar_schema = &#123;</span><br><span class="line">  body: &#123;</span><br><span class="line">    avatar,</span><br><span class="line">  &#125;,</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>在 <code>/router/userinfo.js</code> 模块中，导入需要的验证规则对象：</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> &#123; update_avatar_schema &#125; = <span class="built_in">require</span>(<span class="string">'../schema/user'</span>)</span><br></pre></td></tr></table></figure>
<p>在 <code>/router/userinfo.js</code> 模块中，修改 <code>更新用户头像</code> 的路由如下：</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">router.post(<span class="string">'/update/avatar'</span>, expressJoi(update_avatar_schema), userinfo_handler.updateAvatar)</span><br></pre></td></tr></table></figure>
<h4 id="实现更新用户头像的功能"><a href="#实现更新用户头像的功能" class="headerlink" title="实现更新用户头像的功能"></a>实现更新用户头像的功能</h4><p>定义更新用户头像的 SQL 语句：</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> sql = <span class="string">'update ev_users set user_pic=? where id=?'</span></span><br></pre></td></tr></table></figure>
<p>调用 <code>db.query()</code> 执行 SQL 语句，更新对应用户的头像：</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">db.query(sql, [req.body.avatar, req.user.id], (err, results) =&gt; &#123;</span><br><span class="line">  <span class="comment">// 执行 SQL 语句失败</span></span><br><span class="line">  <span class="keyword">if</span> (err) <span class="keyword">return</span> res.cc(err)</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 执行 SQL 语句成功，但是影响行数不等于 1</span></span><br><span class="line">  <span class="keyword">if</span> (results.affectedRows !== <span class="number">1</span>) <span class="keyword">return</span> res.cc(<span class="string">'更新头像失败！'</span>)</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 更新用户头像成功</span></span><br><span class="line">  <span class="keyword">return</span> res.cc(<span class="string">'更新头像成功！'</span>, <span class="number">0</span>)</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure>
<h2 id="文章分类管理"><a href="#文章分类管理" class="headerlink" title="文章分类管理"></a>文章分类管理</h2><h3 id="新建-ev-article-cate-表"><a href="#新建-ev-article-cate-表" class="headerlink" title="新建 ev_article_cate 表"></a>新建 ev_article_cate 表</h3><p><img src="https://brucecai55520.gitee.io/bruceblog/assets/img/ev_article_cate.f52fe7ce.png" alt="文章分类表结构"></p>
<h3 id="获取文章分类列表"><a href="#获取文章分类列表" class="headerlink" title="获取文章分类列表"></a>获取文章分类列表</h3><h4 id="实现步骤-6"><a href="#实现步骤-6" class="headerlink" title="实现步骤"></a>实现步骤</h4><ol>
<li>初始化路由模块</li>
<li>初始化路由处理函数模块</li>
<li>获取文章分类列表数据</li>
</ol>
<h4 id="初始化路由模块-1"><a href="#初始化路由模块-1" class="headerlink" title="初始化路由模块"></a>初始化路由模块</h4><p>创建 <code>/router/artcate.js</code> 路由模块，并初始化如下的代码结构：</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 导入 express</span></span><br><span class="line"><span class="keyword">const</span> express = <span class="built_in">require</span>(<span class="string">'express'</span>)</span><br><span class="line"><span class="comment">// 创建路由对象</span></span><br><span class="line"><span class="keyword">const</span> router = express.Router()</span><br><span class="line"></span><br><span class="line"><span class="comment">// 获取文章分类的列表数据</span></span><br><span class="line">router.get(<span class="string">'/cates'</span>, (req, res) =&gt; &#123;</span><br><span class="line">  res.send(<span class="string">'ok'</span>)</span><br><span class="line">&#125;)</span><br><span class="line"></span><br><span class="line"><span class="comment">// 向外共享路由对象</span></span><br><span class="line"><span class="built_in">module</span>.exports = router</span><br></pre></td></tr></table></figure>
<p>在 <code>app.js</code> 中导入并使用文章分类的路由模块：</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 导入并使用文章分类路由模块</span></span><br><span class="line"><span class="keyword">const</span> artCateRouter = <span class="built_in">require</span>(<span class="string">'./router/artcate'</span>)</span><br><span class="line"><span class="comment">// 为文章分类的路由挂载统一的访问前缀 /my/article</span></span><br><span class="line">app.use(<span class="string">'/my/article'</span>, artCateRouter)</span><br></pre></td></tr></table></figure>
<h4 id="初始化路由处理函数模块-1"><a href="#初始化路由处理函数模块-1" class="headerlink" title="初始化路由处理函数模块"></a>初始化路由处理函数模块</h4><p>创建 <code>/router_handler/artcate.js</code> 路由处理函数模块，并初始化如下的代码结构：</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 获取文章分类列表数据的处理函数</span></span><br><span class="line">exports.getArticleCates = <span class="function">(<span class="params">req, res</span>) =&gt;</span> &#123;</span><br><span class="line">  res.send(<span class="string">'ok'</span>)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>修改 <code>/router/artcate.js</code> 中的代码如下：</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> express = <span class="built_in">require</span>(<span class="string">'express'</span>)</span><br><span class="line"><span class="keyword">const</span> router = express.Router()</span><br><span class="line"></span><br><span class="line"><span class="comment">// 导入文章分类的路由处理函数模块</span></span><br><span class="line"><span class="keyword">const</span> artcate_handler = <span class="built_in">require</span>(<span class="string">'../router_handler/artcate'</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment">// 获取文章分类的列表数据</span></span><br><span class="line">router.get(<span class="string">'/cates'</span>, artcate_handler.getArticleCates)</span><br><span class="line"></span><br><span class="line"><span class="built_in">module</span>.exports = router</span><br></pre></td></tr></table></figure>
<h4 id="获取文章分类列表数据"><a href="#获取文章分类列表数据" class="headerlink" title="获取文章分类列表数据"></a>获取文章分类列表数据</h4><p>在 <code>/router_handler/artcate.js</code> 头部导入数据库操作模块：</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 导入数据库操作模块</span></span><br><span class="line"><span class="keyword">const</span> db = <span class="built_in">require</span>(<span class="string">'../db/index'</span>)</span><br></pre></td></tr></table></figure>
<p>定义 SQL 语句：</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 根据分类的状态，获取所有未被删除的分类列表数据</span></span><br><span class="line"><span class="comment">// is_delete 为 0 表示没有被 标记为删除 的数据</span></span><br><span class="line"><span class="keyword">const</span> sql = <span class="string">'select * from ev_article_cate where is_delete=0 order by id asc'</span></span><br></pre></td></tr></table></figure>
<p>调用 <code>db.query()</code> 执行 SQL 语句：</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">db.query(sql, (err, results) =&gt; &#123;</span><br><span class="line">  <span class="comment">// 1. 执行 SQL 语句失败</span></span><br><span class="line">  <span class="keyword">if</span> (err) <span class="keyword">return</span> res.cc(err)</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 2. 执行 SQL 语句成功</span></span><br><span class="line">  res.send(&#123;</span><br><span class="line">    status: <span class="number">0</span>,</span><br><span class="line">    message: <span class="string">'获取文章分类列表成功！'</span>,</span><br><span class="line">    data: results,</span><br><span class="line">  &#125;)</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure>
<h3 id="新增文章分类"><a href="#新增文章分类" class="headerlink" title="新增文章分类"></a>新增文章分类</h3><h4 id="实现步骤-7"><a href="#实现步骤-7" class="headerlink" title="实现步骤"></a>实现步骤</h4><ol>
<li>定义路由和处理函数</li>
<li>验证表单数据</li>
<li>查询 <code>分类名称</code> 与 <code>分类别名</code> 是否被占用</li>
<li>实现新增文章分类的功能</li>
</ol>
<h4 id="定义路由和处理函数-3"><a href="#定义路由和处理函数-3" class="headerlink" title="定义路由和处理函数"></a>定义路由和处理函数</h4><p>在 <code>/router/artcate.js</code> 模块中，添加 <code>新增文章分类</code> 的路由：</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 新增文章分类的路由</span></span><br><span class="line">router.post(<span class="string">'/addcates'</span>, artcate_handler.addArticleCates)</span><br></pre></td></tr></table></figure>
<p>在 <code>/router_handler/artcate.js</code> 模块中，定义并向外共享 <code>新增文章分类</code> 的路由处理函数：</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 新增文章分类的处理函数</span></span><br><span class="line">exports.addArticleCates = <span class="function">(<span class="params">req, res</span>) =&gt;</span> &#123;</span><br><span class="line">  res.send(<span class="string">'ok'</span>)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="验证表单数据-3"><a href="#验证表单数据-3" class="headerlink" title="验证表单数据"></a>验证表单数据</h4><p>创建 <code>/schema/artcate.js</code> 文章分类数据验证模块，并定义如下的验证规则：</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 导入定义验证规则的模块</span></span><br><span class="line"><span class="keyword">const</span> joi = <span class="built_in">require</span>(<span class="string">'joi'</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment">// 定义 分类名称 和 分类别名 的校验规则</span></span><br><span class="line"><span class="keyword">const</span> name = joi.string().required()</span><br><span class="line"><span class="keyword">const</span> alias = joi.string().alphanum().required()</span><br><span class="line"></span><br><span class="line"><span class="comment">// 校验规则对象 - 添加分类</span></span><br><span class="line">exports.add_cate_schema = &#123;</span><br><span class="line">  body: &#123;</span><br><span class="line">    name,</span><br><span class="line">    alias,</span><br><span class="line">  &#125;,</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>在 <code>/router/artcate.js</code> 模块中，使用 <code>add_cate_schema</code> 对数据进行验证：</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 导入验证数据的中间件</span></span><br><span class="line"><span class="keyword">const</span> expressJoi = <span class="built_in">require</span>(<span class="string">'@escook/express-joi'</span>)</span><br><span class="line"><span class="comment">// 导入文章分类的验证模块</span></span><br><span class="line"><span class="keyword">const</span> &#123; add_cate_schema &#125; = <span class="built_in">require</span>(<span class="string">'../schema/artcate'</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment">// 新增文章分类的路由</span></span><br><span class="line">router.post(<span class="string">'/addcates'</span>, expressJoi(add_cate_schema), artcate_handler.addArticleCates)</span><br></pre></td></tr></table></figure>
<h4 id="查询分类名称与别名是否被占用"><a href="#查询分类名称与别名是否被占用" class="headerlink" title="查询分类名称与别名是否被占用"></a>查询分类名称与别名是否被占用</h4><p>定义查重的 SQL 语句：</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 定义查询 分类名称 与 分类别名 是否被占用的 SQL 语句</span></span><br><span class="line"><span class="keyword">const</span> sql = <span class="string">`select * from ev_article_cate where name=? or alias=?`</span></span><br></pre></td></tr></table></figure>
<p>调用 <code>db.query()</code> 执行查重的操作：</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 执行查重操作</span></span><br><span class="line">db.query(sql, [req.body.name, req.body.alias], (err, results) =&gt; &#123;</span><br><span class="line">  <span class="comment">// 执行 SQL 语句失败</span></span><br><span class="line">  <span class="keyword">if</span> (err) <span class="keyword">return</span> res.cc(err)</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 判断 分类名称 和 分类别名 是否被占用</span></span><br><span class="line">  <span class="keyword">if</span> (results.length === <span class="number">2</span>) <span class="keyword">return</span> res.cc(<span class="string">'分类名称与别名被占用，请更换后重试！'</span>)</span><br><span class="line">  <span class="comment">// 分别判断 分类名称 和 分类别名 是否被占用</span></span><br><span class="line">  <span class="keyword">if</span> (results.length === <span class="number">1</span> &amp;&amp; results[<span class="number">0</span>].name === req.body.name) <span class="keyword">return</span> res.cc(<span class="string">'分类名称被占用，请更换后重试！'</span>)</span><br><span class="line">  <span class="keyword">if</span> (results.length === <span class="number">1</span> &amp;&amp; results[<span class="number">0</span>].alias === req.body.alias) <span class="keyword">return</span> res.cc(<span class="string">'分类别名被占用，请更换后重试！'</span>)</span><br><span class="line"></span><br><span class="line">  <span class="comment">// TODO：新增文章分类</span></span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure>
<h4 id="实现新增文章分类的功能"><a href="#实现新增文章分类的功能" class="headerlink" title="实现新增文章分类的功能"></a>实现新增文章分类的功能</h4><p>定义新增文章分类的 SQL 语句：</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> sql = <span class="string">`insert into ev_article_cate set ?`</span></span><br></pre></td></tr></table></figure>
<p>调用 <code>db.query()</code> 执行新增文章分类的 SQL 语句：</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">db.query(sql, req.body, (err, results) =&gt; &#123;</span><br><span class="line">  <span class="comment">// SQL 语句执行失败</span></span><br><span class="line">  <span class="keyword">if</span> (err) <span class="keyword">return</span> res.cc(err)</span><br><span class="line"></span><br><span class="line">  <span class="comment">// SQL 语句执行成功，但是影响行数不等于 1</span></span><br><span class="line">  <span class="keyword">if</span> (results.affectedRows !== <span class="number">1</span>) <span class="keyword">return</span> res.cc(<span class="string">'新增文章分类失败！'</span>)</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 新增文章分类成功</span></span><br><span class="line">  res.cc(<span class="string">'新增文章分类成功！'</span>, <span class="number">0</span>)</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure>
<h3 id="根据-Id-删除文章分类"><a href="#根据-Id-删除文章分类" class="headerlink" title="根据 Id 删除文章分类"></a>根据 Id 删除文章分类</h3><h4 id="实现步骤-8"><a href="#实现步骤-8" class="headerlink" title="实现步骤"></a>实现步骤</h4><ol>
<li>定义路由和处理函数</li>
<li>验证表单数据</li>
<li>实现删除文章分类的功能</li>
</ol>
<h4 id="定义路由和处理函数-4"><a href="#定义路由和处理函数-4" class="headerlink" title="定义路由和处理函数"></a>定义路由和处理函数</h4><p>在 <code>/router/artcate.js</code> 模块中，添加 <code>删除文章分类</code> 的路由：</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 删除文章分类的路由</span></span><br><span class="line">router.get(<span class="string">'/deletecate/:id'</span>, artcate_handler.deleteCateById)</span><br></pre></td></tr></table></figure>
<p>在 <code>/router_handler/artcate.js</code> 模块中，定义并向外共享 <code>删除文章分类</code> 的路由处理函数：</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 删除文章分类的处理函数</span></span><br><span class="line">exports.deleteCateById = <span class="function">(<span class="params">req, res</span>) =&gt;</span> &#123;</span><br><span class="line">  res.send(<span class="string">'ok'</span>)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="验证表单数据-4"><a href="#验证表单数据-4" class="headerlink" title="验证表单数据"></a>验证表单数据</h4><p>在 <code>/schema/artcate.js</code> 验证规则模块中，定义 id 的验证规则如下：</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 定义 分类Id 的校验规则</span></span><br><span class="line"><span class="keyword">const</span> id = joi.number().integer().min(<span class="number">1</span>).required()</span><br></pre></td></tr></table></figure>
<p>并使用 <code>exports</code> 向外共享如下的 <code>验证规则对象</code>：</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 校验规则对象 - 删除分类</span></span><br><span class="line">exports.delete_cate_schema = &#123;</span><br><span class="line">  params: &#123;</span><br><span class="line">    id,</span><br><span class="line">  &#125;,</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>在 <code>/router/artcate.js</code> 模块中，导入需要的验证规则对象，并在路由中使用：</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 导入删除分类的验证规则对象</span></span><br><span class="line"><span class="keyword">const</span> &#123; delete_cate_schema &#125; = <span class="built_in">require</span>(<span class="string">'../schema/artcate'</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment">// 删除文章分类的路由</span></span><br><span class="line">router.get(<span class="string">'/deletecate/:id'</span>, expressJoi(delete_cate_schema), artcate_handler.deleteCateById)</span><br></pre></td></tr></table></figure>
<h4 id="实现删除文章分类的功能"><a href="#实现删除文章分类的功能" class="headerlink" title="实现删除文章分类的功能"></a>实现删除文章分类的功能</h4><p>定义删除文章分类的 SQL 语句：</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> sql = <span class="string">`update ev_article_cate set is_delete=1 where id=?`</span></span><br></pre></td></tr></table></figure>
<p>调用 <code>db.query()</code> 执行删除文章分类的 SQL 语句：</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">db.query(sql, req.params.id, (err, results) =&gt; &#123;</span><br><span class="line">  <span class="comment">// 执行 SQL 语句失败</span></span><br><span class="line">  <span class="keyword">if</span> (err) <span class="keyword">return</span> res.cc(err)</span><br><span class="line"></span><br><span class="line">  <span class="comment">// SQL 语句执行成功，但是影响行数不等于 1</span></span><br><span class="line">  <span class="keyword">if</span> (results.affectedRows !== <span class="number">1</span>) <span class="keyword">return</span> res.cc(<span class="string">'删除文章分类失败！'</span>)</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 删除文章分类成功</span></span><br><span class="line">  res.cc(<span class="string">'删除文章分类成功！'</span>, <span class="number">0</span>)</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure>
<h3 id="根据-Id-获取文章分类数据"><a href="#根据-Id-获取文章分类数据" class="headerlink" title="根据 Id 获取文章分类数据"></a>根据 Id 获取文章分类数据</h3><h4 id="实现步骤-9"><a href="#实现步骤-9" class="headerlink" title="实现步骤"></a>实现步骤</h4><ol>
<li>定义路由和处理函数</li>
<li>验证表单数据</li>
<li>实现获取文章分类的功能</li>
</ol>
<h4 id="定义路由和处理函数-5"><a href="#定义路由和处理函数-5" class="headerlink" title="定义路由和处理函数"></a>定义路由和处理函数</h4><p>在 <code>/router/artcate.js</code> 模块中，添加 <code>根据 Id 获取文章分类</code> 的路由：</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">router.get(<span class="string">'/cates/:id'</span>, artcate_handler.getArticleById)</span><br></pre></td></tr></table></figure>
<p>在 <code>/router_handler/artcate.js</code> 模块中，定义并向外共享 <code>根据 Id 获取文章分类</code> 的路由处理函数：</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 根据 Id 获取文章分类的处理函数</span></span><br><span class="line">exports.getArticleById = <span class="function">(<span class="params">req, res</span>) =&gt;</span> &#123;</span><br><span class="line">  res.send(<span class="string">'ok'</span>)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="验证表单数据-5"><a href="#验证表单数据-5" class="headerlink" title="验证表单数据"></a>验证表单数据</h4><p>在 <code>/schema/artcate.js</code> 验证规则模块中，使用 <code>exports</code> 向外共享如下的 <code>验证规则对象</code>：</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 校验规则对象 - 根据 Id 获取分类</span></span><br><span class="line">exports.get_cate_schema = &#123;</span><br><span class="line">  params: &#123;</span><br><span class="line">    id,</span><br><span class="line">  &#125;,</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>在 <code>/router/artcate.js</code> 模块中，导入需要的验证规则对象，并在路由中使用：</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 导入根据 Id 获取分类的验证规则对象</span></span><br><span class="line"><span class="keyword">const</span> &#123; get_cate_schema &#125; = <span class="built_in">require</span>(<span class="string">'../schema/artcate'</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment">// 根据 Id 获取文章分类的路由</span></span><br><span class="line">router.get(<span class="string">'/cates/:id'</span>, expressJoi(get_cate_schema), artcate_handler.getArticleById)</span><br></pre></td></tr></table></figure>
<h4 id="实现获取文章分类的功能"><a href="#实现获取文章分类的功能" class="headerlink" title="实现获取文章分类的功能"></a>实现获取文章分类的功能</h4><p>定义根据 Id 获取文章分类的 SQL 语句：</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> sql = <span class="string">`select * from ev_article_cate where id=?`</span></span><br></pre></td></tr></table></figure>
<p>调用 <code>db.query()</code> 执行 SQL 语句：</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">db.query(sql, req.params.id, (err, results) =&gt; &#123;</span><br><span class="line">  <span class="comment">// 执行 SQL 语句失败</span></span><br><span class="line">  <span class="keyword">if</span> (err) <span class="keyword">return</span> res.cc(err)</span><br><span class="line"></span><br><span class="line">  <span class="comment">// SQL 语句执行成功，但是没有查询到任何数据</span></span><br><span class="line">  <span class="keyword">if</span> (results.length !== <span class="number">1</span>) <span class="keyword">return</span> res.cc(<span class="string">'获取文章分类数据失败！'</span>)</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 把数据响应给客户端</span></span><br><span class="line">  res.send(&#123;</span><br><span class="line">    status: <span class="number">0</span>,</span><br><span class="line">    message: <span class="string">'获取文章分类数据成功！'</span>,</span><br><span class="line">    data: results[<span class="number">0</span>],</span><br><span class="line">  &#125;)</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure>
<h3 id="根据-Id-更新文章分类数据"><a href="#根据-Id-更新文章分类数据" class="headerlink" title="根据 Id 更新文章分类数据"></a>根据 Id 更新文章分类数据</h3><h4 id="实现步骤-10"><a href="#实现步骤-10" class="headerlink" title="实现步骤"></a>实现步骤</h4><ol>
<li>定义路由和处理函数</li>
<li>验证表单数据</li>
<li>查询 <code>分类名称</code> 与 <code>分类别名</code> 是否被占用</li>
<li>实现更新文章分类的功能</li>
</ol>
<h4 id="定义路由和处理函数-6"><a href="#定义路由和处理函数-6" class="headerlink" title="定义路由和处理函数"></a>定义路由和处理函数</h4><p>在 <code>/router/artcate.js</code> 模块中，添加 <code>更新文章分类</code> 的路由：</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 更新文章分类的路由</span></span><br><span class="line">router.post(<span class="string">'/updatecate'</span>, artcate_handler.updateCateById)</span><br></pre></td></tr></table></figure>
<p>在 <code>/router_handler/artcate.js</code> 模块中，定义并向外共享 <code>更新文章分类</code> 的路由处理函数：</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 更新文章分类的处理函数</span></span><br><span class="line">exports.updateCateById = <span class="function">(<span class="params">req, res</span>) =&gt;</span> &#123;</span><br><span class="line">  res.send(<span class="string">'ok'</span>)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="验证表单数据-6"><a href="#验证表单数据-6" class="headerlink" title="验证表单数据"></a>验证表单数据</h4><p>在 <code>/schema/artcate.js</code> 验证规则模块中，使用 <code>exports</code> 向外共享如下的 <code>验证规则对象</code>：</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 校验规则对象 - 更新分类</span></span><br><span class="line">exports.update_cate_schema = &#123;</span><br><span class="line">  body: &#123;</span><br><span class="line">    Id: id,</span><br><span class="line">    name,</span><br><span class="line">    alias,</span><br><span class="line">  &#125;,</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>在 <code>/router/artcate.js</code> 模块中，导入需要的验证规则对象，并在路由中使用：</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 导入更新文章分类的验证规则对象</span></span><br><span class="line"><span class="keyword">const</span> &#123; update_cate_schema &#125; = <span class="built_in">require</span>(<span class="string">'../schema/artcate'</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment">// 更新文章分类的路由</span></span><br><span class="line">router.post(<span class="string">'/updatecate'</span>, expressJoi(update_cate_schema), artcate_handler.updateCateById)</span><br></pre></td></tr></table></figure>
<h4 id="查询分类名称与别名是否被占用-1"><a href="#查询分类名称与别名是否被占用-1" class="headerlink" title="查询分类名称与别名是否被占用"></a>查询分类名称与别名是否被占用</h4><p>定义查重的 SQL 语句：</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 定义查询 分类名称 与 分类别名 是否被占用的 SQL 语句</span></span><br><span class="line"><span class="keyword">const</span> sql = <span class="string">`select * from ev_article_cate where Id&lt;&gt;? and (name=? or alias=?)`</span></span><br></pre></td></tr></table></figure>
<p>调用 <code>db.query()</code> 执行查重的操作：</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 执行查重操作</span></span><br><span class="line">db.query(sql, [req.body.Id, req.body.name, req.body.alias], (err, results) =&gt; &#123;</span><br><span class="line">  <span class="comment">// 执行 SQL 语句失败</span></span><br><span class="line">  <span class="keyword">if</span> (err) <span class="keyword">return</span> res.cc(err)</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 判断 分类名称 和 分类别名 是否被占用</span></span><br><span class="line">  <span class="keyword">if</span> (results.length === <span class="number">2</span>) <span class="keyword">return</span> res.cc(<span class="string">'分类名称与别名被占用，请更换后重试！'</span>)</span><br><span class="line">  <span class="keyword">if</span> (results.length === <span class="number">1</span> &amp;&amp; results[<span class="number">0</span>].name === req.body.name) <span class="keyword">return</span> res.cc(<span class="string">'分类名称被占用，请更换后重试！'</span>)</span><br><span class="line">  <span class="keyword">if</span> (results.length === <span class="number">1</span> &amp;&amp; results[<span class="number">0</span>].alias === req.body.alias) <span class="keyword">return</span> res.cc(<span class="string">'分类别名被占用，请更换后重试！'</span>)</span><br><span class="line"></span><br><span class="line">  <span class="comment">// TODO：更新文章分类</span></span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure>
<h4 id="实现更新文章分类的功能"><a href="#实现更新文章分类的功能" class="headerlink" title="实现更新文章分类的功能"></a>实现更新文章分类的功能</h4><p>定义更新文章分类的 SQL 语句：</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> sql = <span class="string">`update ev_article_cate set ? where Id=?`</span></span><br></pre></td></tr></table></figure>
<p>调用 <code>db.query()</code> 执行 SQL 语句：</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">db.query(sql, [req.body, req.body.Id], (err, results) =&gt; &#123;</span><br><span class="line">  <span class="comment">// 执行 SQL 语句失败</span></span><br><span class="line">  <span class="keyword">if</span> (err) <span class="keyword">return</span> res.cc(err)</span><br><span class="line"></span><br><span class="line">  <span class="comment">// SQL 语句执行成功，但是影响行数不等于 1</span></span><br><span class="line">  <span class="keyword">if</span> (results.affectedRows !== <span class="number">1</span>) <span class="keyword">return</span> res.cc(<span class="string">'更新文章分类失败！'</span>)</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 更新文章分类成功</span></span><br><span class="line">  res.cc(<span class="string">'更新文章分类成功！'</span>, <span class="number">0</span>)</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure>
<h2 id="文章管理"><a href="#文章管理" class="headerlink" title="文章管理"></a>文章管理</h2><h3 id="新建-ev-articles-表"><a href="#新建-ev-articles-表" class="headerlink" title="新建 ev_articles 表"></a>新建 ev_articles 表</h3><p><img src="https://brucecai55520.gitee.io/bruceblog/assets/img/ev_articles.01220b03.png" alt="ev_articles表结构"></p>
<h3 id="发布新文章"><a href="#发布新文章" class="headerlink" title="发布新文章"></a>发布新文章</h3><h4 id="实现步骤-11"><a href="#实现步骤-11" class="headerlink" title="实现步骤"></a>实现步骤</h4><ol>
<li>初始化路由模块</li>
<li>初始化路由处理函数模块</li>
<li>使用 multer 解析表单数据</li>
<li>验证表单数据</li>
<li>实现发布文章的功能</li>
</ol>
<h4 id="初始化路由模块-2"><a href="#初始化路由模块-2" class="headerlink" title="初始化路由模块"></a>初始化路由模块</h4><p>创建 <code>/router/article.js</code> 路由模块，并初始化如下的代码结构：</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 导入 express</span></span><br><span class="line"><span class="keyword">const</span> express = <span class="built_in">require</span>(<span class="string">'express'</span>)</span><br><span class="line"><span class="comment">// 创建路由对象</span></span><br><span class="line"><span class="keyword">const</span> router = express.Router()</span><br><span class="line"></span><br><span class="line"><span class="comment">// 发布新文章</span></span><br><span class="line">router.post(<span class="string">'/add'</span>, (req, res) =&gt; &#123;</span><br><span class="line">  res.send(<span class="string">'ok'</span>)</span><br><span class="line">&#125;)</span><br><span class="line"></span><br><span class="line"><span class="comment">// 向外共享路由对象</span></span><br><span class="line"><span class="built_in">module</span>.exports = router</span><br></pre></td></tr></table></figure>
<p>在 <code>app.js</code> 中导入并使用文章的路由模块：</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 导入并使用文章路由模块</span></span><br><span class="line"><span class="keyword">const</span> articleRouter = <span class="built_in">require</span>(<span class="string">'./router/article'</span>)</span><br><span class="line"><span class="comment">// 为文章的路由挂载统一的访问前缀 /my/article</span></span><br><span class="line">app.use(<span class="string">'/my/article'</span>, articleRouter)</span><br></pre></td></tr></table></figure>
<h4 id="初始化路由处理函数模块-2"><a href="#初始化路由处理函数模块-2" class="headerlink" title="初始化路由处理函数模块"></a>初始化路由处理函数模块</h4><p>创建 <code>/router_handler/article.js</code> 路由处理函数模块，并初始化如下的代码结构：</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 发布新文章的处理函数</span></span><br><span class="line">exports.addArticle = <span class="function">(<span class="params">req, res</span>) =&gt;</span> &#123;</span><br><span class="line">  res.send(<span class="string">'ok'</span>)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>修改 <code>/router/article.js</code> 中的代码如下：</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> express = <span class="built_in">require</span>(<span class="string">'express'</span>)</span><br><span class="line"><span class="keyword">const</span> router = express.Router()</span><br><span class="line"></span><br><span class="line"><span class="comment">// 导入文章的路由处理函数模块</span></span><br><span class="line"><span class="keyword">const</span> article_handler = <span class="built_in">require</span>(<span class="string">'../router_handler/article'</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment">// 发布新文章</span></span><br><span class="line">router.post(<span class="string">'/add'</span>, article_handler.addArticle)</span><br><span class="line"></span><br><span class="line"><span class="built_in">module</span>.exports = router</span><br></pre></td></tr></table></figure>
<h4 id="使用-multer-解析表单数据"><a href="#使用-multer-解析表单数据" class="headerlink" title="使用 multer 解析表单数据"></a>使用 multer 解析表单数据</h4><blockquote>
<p>注意：使用 <code>express.urlencoded()</code> 中间件无法解析 <code>multipart/form-data</code> 格式的请求体数据。</p>
</blockquote>
<blockquote>
<p>当前项目，推荐使用 multer 来解析 <code>multipart/form-data</code> 格式的表单数据。<a href="https://www.npmjs.com/package/multer" target="_blank" rel="noopener">https://www.npmjs.com/package/multer</a></p>
</blockquote>
<p>运行如下的终端命令，在项目中安装 <code>multer</code>：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">npm i multer@1.4.2</span><br></pre></td></tr></table></figure>
<p>在 <code>/router_handler/article.js</code> 模块中导入并配置 <code>multer</code>：</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 导入解析 formdata 格式表单数据的包</span></span><br><span class="line"><span class="keyword">const</span> multer = <span class="built_in">require</span>(<span class="string">'multer'</span>)</span><br><span class="line"><span class="comment">// 导入处理路径的核心模块</span></span><br><span class="line"><span class="keyword">const</span> path = <span class="built_in">require</span>(<span class="string">'path'</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment">// 创建 multer 的实例对象，通过 dest 属性指定文件的存放路径</span></span><br><span class="line"><span class="keyword">const</span> upload = multer(&#123; <span class="attr">dest</span>: path.join(__dirname, <span class="string">'../uploads'</span>) &#125;)</span><br></pre></td></tr></table></figure>
<p>修改 <code>发布新文章</code> 的路由如下：</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 发布新文章的路由</span></span><br><span class="line"><span class="comment">// upload.single() 是一个局部生效的中间件，用来解析 FormData 格式的表单数据</span></span><br><span class="line"><span class="comment">// 将文件类型的数据，解析并挂载到 req.file 属性中</span></span><br><span class="line"><span class="comment">// 将文本类型的数据，解析并挂载到 req.body 属性中</span></span><br><span class="line">router.post(<span class="string">'/add'</span>, upload.single(<span class="string">'cover_img'</span>), article_handler.addArticle)</span><br></pre></td></tr></table></figure>
<p>在 <code>/router_handler/article.js</code> 模块中的 <code>addArticle</code> 处理函数中，将 <code>multer</code> 解析出来的数据进行打印：</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 发布新文章的处理函数</span></span><br><span class="line">exports.addArticle = <span class="function">(<span class="params">req, res</span>) =&gt;</span> &#123;</span><br><span class="line">  <span class="built_in">console</span>.log(req.body) <span class="comment">// 文本类型的数据</span></span><br><span class="line">  <span class="built_in">console</span>.log(<span class="string">'--------分割线----------'</span>)</span><br><span class="line">  <span class="built_in">console</span>.log(req.file) <span class="comment">// 文件类型的数据</span></span><br><span class="line"></span><br><span class="line">  res.send(<span class="string">'ok'</span>)</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure>
<h4 id="验证表单数据-7"><a href="#验证表单数据-7" class="headerlink" title="验证表单数据"></a>验证表单数据</h4><blockquote>
<p>实现思路：通过 express-joi <strong>自动验证</strong> req.body 中的文本数据；通过 if 判断<strong>手动验证</strong> req.file 中的文件数据；</p>
</blockquote>
<p>创建 <code>/schema/article.js</code> 验证规则模块，并初始化如下的代码结构：</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 导入定义验证规则的模块</span></span><br><span class="line"><span class="keyword">const</span> joi = <span class="built_in">require</span>(<span class="string">'joi'</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment">// 定义 标题、分类Id、内容、发布状态 的验证规则</span></span><br><span class="line"><span class="keyword">const</span> title = joi.string().required()</span><br><span class="line"><span class="keyword">const</span> cate_id = joi.number().integer().min(<span class="number">1</span>).required()</span><br><span class="line"><span class="keyword">const</span> content = joi.string().required().allow(<span class="string">''</span>)</span><br><span class="line"><span class="keyword">const</span> state = joi.string().valid(<span class="string">'已发布'</span>, <span class="string">'草稿'</span>).required()</span><br><span class="line"></span><br><span class="line"><span class="comment">// 验证规则对象 - 发布文章</span></span><br><span class="line">exports.add_article_schema = &#123;</span><br><span class="line">  body: &#123;</span><br><span class="line">    title,</span><br><span class="line">    cate_id,</span><br><span class="line">    content,</span><br><span class="line">    state,</span><br><span class="line">  &#125;,</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>在 <code>/router/article.js</code> 模块中，导入需要的验证规则对象，并在路由中使用：</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 导入验证数据的中间件</span></span><br><span class="line"><span class="keyword">const</span> expressJoi = <span class="built_in">require</span>(<span class="string">'@escook/express-joi'</span>)</span><br><span class="line"><span class="comment">// 导入文章的验证模块</span></span><br><span class="line"><span class="keyword">const</span> &#123; add_article_schema &#125; = <span class="built_in">require</span>(<span class="string">'../schema/article'</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment">// 发布新文章的路由</span></span><br><span class="line"><span class="comment">// 注意：在当前的路由中，先后使用了两个中间件：</span></span><br><span class="line"><span class="comment">//       先使用 multer 解析表单数据</span></span><br><span class="line"><span class="comment">//       再使用 expressJoi 对解析的表单数据进行验证</span></span><br><span class="line">router.post(<span class="string">'/add'</span>, upload.single(<span class="string">'cover_img'</span>), expressJoi(add_article_schema), article_handler.addArticle)</span><br></pre></td></tr></table></figure>
<p>在 <code>/router_handler/article.js</code> 模块中的 <code>addArticle</code> 处理函数中，通过 <code>if</code> 判断客户端是否提交了 <code>封面图片</code>：</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 发布新文章的处理函数</span></span><br><span class="line">exports.addArticle = <span class="function">(<span class="params">req, res</span>) =&gt;</span> &#123;</span><br><span class="line">    <span class="comment">// 手动判断是否上传了文章封面</span></span><br><span class="line">  <span class="keyword">if</span> (!req.file || req.file.fieldname !== <span class="string">'cover_img'</span>) <span class="keyword">return</span> res.cc(<span class="string">'文章封面是必选参数！'</span>)</span><br><span class="line"></span><br><span class="line">  <span class="comment">// TODO：表单数据合法，继续后面的处理流程...</span></span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure>
<h4 id="实现发布文章的功能"><a href="#实现发布文章的功能" class="headerlink" title="实现发布文章的功能"></a>实现发布文章的功能</h4><p>整理要插入数据库的文章信息对象：</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 导入处理路径的 path 核心模块</span></span><br><span class="line"><span class="keyword">const</span> path = <span class="built_in">require</span>(<span class="string">'path'</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> articleInfo = &#123;</span><br><span class="line">  <span class="comment">// 标题、内容、状态、所属的分类Id</span></span><br><span class="line">  ...req.body,</span><br><span class="line">  <span class="comment">// 文章封面在服务器端的存放路径</span></span><br><span class="line">  cover_img: path.join(<span class="string">'/uploads'</span>, req.file.filename),</span><br><span class="line">  <span class="comment">// 文章发布时间</span></span><br><span class="line">  pub_date: <span class="keyword">new</span> <span class="built_in">Date</span>(),</span><br><span class="line">  <span class="comment">// 文章作者的Id</span></span><br><span class="line">  author_id: req.user.id,</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>定义发布文章的 SQL 语句：</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> sql = <span class="string">`insert into ev_articles set ?`</span></span><br></pre></td></tr></table></figure>
<p>调用 <code>db.query()</code> 执行发布文章的 SQL 语句：</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 导入数据库操作模块</span></span><br><span class="line"><span class="keyword">const</span> db = <span class="built_in">require</span>(<span class="string">'../db/index'</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment">// 执行 SQL 语句</span></span><br><span class="line">db.query(sql, articleInfo, (err, results) =&gt; &#123;</span><br><span class="line">  <span class="comment">// 执行 SQL 语句失败</span></span><br><span class="line">  <span class="keyword">if</span> (err) <span class="keyword">return</span> res.cc(err)</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 执行 SQL 语句成功，但是影响行数不等于 1</span></span><br><span class="line">  <span class="keyword">if</span> (results.affectedRows !== <span class="number">1</span>) <span class="keyword">return</span> res.cc(<span class="string">'发布文章失败！'</span>)</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 发布文章成功</span></span><br><span class="line">  res.cc(<span class="string">'发布文章成功'</span>, <span class="number">0</span>)</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure>
<p>在 <code>app.js</code> 中，使用 <code>express.static()</code> 中间件，将 <code>uploads</code> 目录中的图片托管为静态资源：</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 托管静态资源文件</span></span><br><span class="line">app.use(<span class="string">'/uploads'</span>, express.static(<span class="string">'./uploads'</span>))</span><br></pre></td></tr></table></figure>

    </div>

    
    
    

      <footer class="post-footer">

        

          <div class="post-nav">
            <div class="post-nav-next post-nav-item">
                <a href="/2022/09/06/react复习笔记/" rel="next" title="react复习笔记">
                  <i class="fa fa-chevron-left"></i> react复习笔记
                </a>
            </div>

            <span class="post-nav-divider"></span>

            <div class="post-nav-prev post-nav-item">
                <a href="/2023/03/20/整理面试题/" rel="prev" title="">
                   <i class="fa fa-chevron-right"></i>
                </a>
            </div>
          </div>
      </footer>
    
  </article>
  
  
  

  </div>


          </div>
          

        </div>
          
  
  <div class="toggle sidebar-toggle">
    <span class="toggle-line toggle-line-first"></span>
    <span class="toggle-line toggle-line-middle"></span>
    <span class="toggle-line toggle-line-last"></span>
  </div>

  <aside class="sidebar">
    <div class="sidebar-inner">

      <ul class="sidebar-nav motion-element">
        <li class="sidebar-nav-toc">
          文章目录
        </li>
        <li class="sidebar-nav-overview">
          站点概览
        </li>
      </ul>

      <!--noindex-->
      <div class="post-toc-wrap sidebar-panel">
          <div class="post-toc motion-element"><ol class="nav"><li class="nav-item nav-level-2"><a class="nav-link" href="#Nodejs复习手册"><span class="nav-number">1.</span> <span class="nav-text">Nodejs复习手册</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#初识-Nodejs"><span class="nav-number">1.1.</span> <span class="nav-text">初识 Nodejs</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#fs文件系统模块"><span class="nav-number">2.</span> <span class="nav-text">fs文件系统模块</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#路径动态拼接问题-dirname"><span class="nav-number">2.1.</span> <span class="nav-text">路径动态拼接问题 __dirname</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#其它操作"><span class="nav-number">2.2.</span> <span class="nav-text">其它操作</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#path-路径模块"><span class="nav-number">3.</span> <span class="nav-text">path 路径模块</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#路径拼接-path-join"><span class="nav-number">3.1.</span> <span class="nav-text">路径拼接 path.join()</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#获取路径中文件名-path-basename"><span class="nav-number">3.2.</span> <span class="nav-text">获取路径中文件名 path.basename()</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#获取路径中文件扩展名-path-extname"><span class="nav-number">3.3.</span> <span class="nav-text">获取路径中文件扩展名 path.extname()</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#http-模块"><span class="nav-number">4.</span> <span class="nav-text">http 模块</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#创建基本-Web-服务器"><span class="nav-number">4.1.</span> <span class="nav-text">创建基本 Web 服务器</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#实现简陋路由效果"><span class="nav-number">4.2.</span> <span class="nav-text">实现简陋路由效果</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#模块化"><span class="nav-number">5.</span> <span class="nav-text">模块化</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#模块化概念"><span class="nav-number">5.1.</span> <span class="nav-text">模块化概念</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Node-js-中模块的分类"><span class="nav-number">5.2.</span> <span class="nav-text">Node.js 中模块的分类</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Node-js-中的模块作用域"><span class="nav-number">5.3.</span> <span class="nav-text">Node.js 中的模块作用域</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#模块作用域的成员"><span class="nav-number">5.4.</span> <span class="nav-text">模块作用域的成员</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#CommonJS-模块化规范"><span class="nav-number">5.5.</span> <span class="nav-text">CommonJS 模块化规范</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#模块加载机制"><span class="nav-number">5.6.</span> <span class="nav-text">模块加载机制</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#内置模块加载"><span class="nav-number">5.6.1.</span> <span class="nav-text">内置模块加载</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#自定义模块加载"><span class="nav-number">5.6.2.</span> <span class="nav-text">自定义模块加载</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#第三方模块加载"><span class="nav-number">5.6.3.</span> <span class="nav-text">第三方模块加载</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#目录作为模块加载"><span class="nav-number">5.6.4.</span> <span class="nav-text">目录作为模块加载</span></a></li></ol></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Express"><span class="nav-number">6.</span> <span class="nav-text">Express</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Express-初体验"><span class="nav-number">7.</span> <span class="nav-text">Express 初体验</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#基本使用"><span class="nav-number">7.1.</span> <span class="nav-text">基本使用</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#托管静态资源"><span class="nav-number">7.2.</span> <span class="nav-text">托管静态资源</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Express-路由"><span class="nav-number">8.</span> <span class="nav-text">Express 路由</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Express-中间件"><span class="nav-number">9.</span> <span class="nav-text">Express 中间件</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#全局中间件"><span class="nav-number">9.1.</span> <span class="nav-text">全局中间件</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#局部中间件"><span class="nav-number">9.2.</span> <span class="nav-text">局部中间件</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#中间件分类"><span class="nav-number">9.3.</span> <span class="nav-text">中间件分类</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#CORS-跨域资源共享"><span class="nav-number">10.</span> <span class="nav-text">CORS 跨域资源共享</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#cors-中间件解决跨域"><span class="nav-number">10.1.</span> <span class="nav-text">cors 中间件解决跨域</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#CORS"><span class="nav-number">10.2.</span> <span class="nav-text">CORS</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#CORS-常见响应头"><span class="nav-number">10.3.</span> <span class="nav-text">CORS 常见响应头</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#CORS-请求分类"><span class="nav-number">10.4.</span> <span class="nav-text">CORS 请求分类</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#简单请求"><span class="nav-number">10.4.1.</span> <span class="nav-text">简单请求</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#预检请求"><span class="nav-number">10.4.2.</span> <span class="nav-text">预检请求</span></a></li></ol></li></ol></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#数据库和身份认证"><span class="nav-number"></span> <span class="nav-text">数据库和身份认证</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#Node-操作-mysql"><span class="nav-number">1.</span> <span class="nav-text">Node 操作 mysql</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#配置-mysql-模块"><span class="nav-number">1.1.</span> <span class="nav-text">配置 mysql 模块</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#操作-mysql-数据库"><span class="nav-number">1.2.</span> <span class="nav-text">操作 mysql 数据库</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Web-开发模式"><span class="nav-number">2.</span> <span class="nav-text">Web 开发模式</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#服务端渲染"><span class="nav-number">2.1.</span> <span class="nav-text">服务端渲染</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#前后端分离"><span class="nav-number">2.2.</span> <span class="nav-text">前后端分离</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#如何选择"><span class="nav-number">2.3.</span> <span class="nav-text">如何选择</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#身份认证"><span class="nav-number">3.</span> <span class="nav-text">身份认证</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#Session-认证机制"><span class="nav-number">3.1.</span> <span class="nav-text">Session 认证机制</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#Session-工作原理"><span class="nav-number">3.1.1.</span> <span class="nav-text">Session 工作原理</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#Express-中使用-Session-认证"><span class="nav-number">3.1.2.</span> <span class="nav-text">Express 中使用 Session 认证</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#JWT-认证机制"><span class="nav-number">3.2.</span> <span class="nav-text">JWT 认证机制</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#JWT-工作原理"><span class="nav-number">3.2.1.</span> <span class="nav-text">JWT 工作原理</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#Express-使用-JWT"><span class="nav-number">3.2.2.</span> <span class="nav-text">Express 使用 JWT</span></a></li></ol></li></ol></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#大事件后台-API-项目"><span class="nav-number"></span> <span class="nav-text">大事件后台 API 项目</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#1-项目初始化"><span class="nav-number">1.</span> <span class="nav-text">1. 项目初始化</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#创建项目"><span class="nav-number">1.1.</span> <span class="nav-text">创建项目</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#配置-cors-跨域"><span class="nav-number">1.2.</span> <span class="nav-text">配置 cors 跨域</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#配置解析表单数据的中间件"><span class="nav-number">1.3.</span> <span class="nav-text">配置解析表单数据的中间件</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#初始化路由相关的文件夹"><span class="nav-number">1.4.</span> <span class="nav-text">初始化路由相关的文件夹</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#初始化用户路由模块"><span class="nav-number">1.5.</span> <span class="nav-text">初始化用户路由模块</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#抽离用户路由模块中的处理函数"><span class="nav-number">1.6.</span> <span class="nav-text">抽离用户路由模块中的处理函数</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#登录注册"><span class="nav-number">2.</span> <span class="nav-text">登录注册</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#新建-ev-users-表"><span class="nav-number">2.1.</span> <span class="nav-text">新建 ev_users 表</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#安装并配置-mysql-模块"><span class="nav-number">2.2.</span> <span class="nav-text">安装并配置 mysql 模块</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#注册"><span class="nav-number">2.3.</span> <span class="nav-text">注册</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#实现步骤"><span class="nav-number">2.3.1.</span> <span class="nav-text">实现步骤</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#检测表单数据是否合法"><span class="nav-number">2.3.2.</span> <span class="nav-text">检测表单数据是否合法</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#检测用户名是否被占用"><span class="nav-number">2.3.3.</span> <span class="nav-text">检测用户名是否被占用</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#对密码进行加密处理"><span class="nav-number">2.3.4.</span> <span class="nav-text">对密码进行加密处理</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#插入新用户"><span class="nav-number">2.3.5.</span> <span class="nav-text">插入新用户</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#优化-res-send-代码"><span class="nav-number">2.4.</span> <span class="nav-text">优化 res.send() 代码</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#优化表单数据验证"><span class="nav-number">2.5.</span> <span class="nav-text">优化表单数据验证</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#登录"><span class="nav-number">2.6.</span> <span class="nav-text">登录</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#实现步骤-1"><span class="nav-number">2.6.1.</span> <span class="nav-text">实现步骤</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#检测登录表单的数据是否合法"><span class="nav-number">2.6.2.</span> <span class="nav-text">检测登录表单的数据是否合法</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#根据用户名查询用户的数据"><span class="nav-number">2.6.3.</span> <span class="nav-text">根据用户名查询用户的数据</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#判断用户输入的密码是否正确"><span class="nav-number">2.6.4.</span> <span class="nav-text">判断用户输入的密码是否正确</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#生成-JWT-的-Token-字符串"><span class="nav-number">2.6.5.</span> <span class="nav-text">生成 JWT 的 Token 字符串</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#配置解析-Token-的中间件"><span class="nav-number">2.7.</span> <span class="nav-text">配置解析 Token 的中间件</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#个人中心"><span class="nav-number">3.</span> <span class="nav-text">个人中心</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#获取用户的基本信息"><span class="nav-number">3.1.</span> <span class="nav-text">获取用户的基本信息</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#实现步骤-2"><span class="nav-number">3.1.1.</span> <span class="nav-text">实现步骤</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#初始化路由模块"><span class="nav-number">3.1.2.</span> <span class="nav-text">初始化路由模块</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#初始化路由处理函数模块"><span class="nav-number">3.1.3.</span> <span class="nav-text">初始化路由处理函数模块</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#获取用户的基本信息-1"><span class="nav-number">3.1.4.</span> <span class="nav-text">获取用户的基本信息</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#更新用户的基本信息"><span class="nav-number">3.2.</span> <span class="nav-text">更新用户的基本信息</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#实现步骤-3"><span class="nav-number">3.2.1.</span> <span class="nav-text">实现步骤</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#定义路由和处理函数"><span class="nav-number">3.2.2.</span> <span class="nav-text">定义路由和处理函数</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#验证表单数据"><span class="nav-number">3.2.3.</span> <span class="nav-text">验证表单数据</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#实现更新用户基本信息的功能"><span class="nav-number">3.2.4.</span> <span class="nav-text">实现更新用户基本信息的功能</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#重置密码"><span class="nav-number">3.3.</span> <span class="nav-text">重置密码</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#实现步骤-4"><span class="nav-number">3.3.1.</span> <span class="nav-text">实现步骤</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#定义路由和处理函数-1"><span class="nav-number">3.3.2.</span> <span class="nav-text">定义路由和处理函数</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#验证表单数据-1"><span class="nav-number">3.3.3.</span> <span class="nav-text">验证表单数据</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#实现重置密码的功能"><span class="nav-number">3.3.4.</span> <span class="nav-text">实现重置密码的功能</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#更新用户头像"><span class="nav-number">3.4.</span> <span class="nav-text">更新用户头像</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#实现步骤-5"><span class="nav-number">3.4.1.</span> <span class="nav-text">实现步骤</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#定义路由和处理函数-2"><span class="nav-number">3.4.2.</span> <span class="nav-text">定义路由和处理函数</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#验证表单数据-2"><span class="nav-number">3.4.3.</span> <span class="nav-text">验证表单数据</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#实现更新用户头像的功能"><span class="nav-number">3.4.4.</span> <span class="nav-text">实现更新用户头像的功能</span></a></li></ol></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#文章分类管理"><span class="nav-number">4.</span> <span class="nav-text">文章分类管理</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#新建-ev-article-cate-表"><span class="nav-number">4.1.</span> <span class="nav-text">新建 ev_article_cate 表</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#获取文章分类列表"><span class="nav-number">4.2.</span> <span class="nav-text">获取文章分类列表</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#实现步骤-6"><span class="nav-number">4.2.1.</span> <span class="nav-text">实现步骤</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#初始化路由模块-1"><span class="nav-number">4.2.2.</span> <span class="nav-text">初始化路由模块</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#初始化路由处理函数模块-1"><span class="nav-number">4.2.3.</span> <span class="nav-text">初始化路由处理函数模块</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#获取文章分类列表数据"><span class="nav-number">4.2.4.</span> <span class="nav-text">获取文章分类列表数据</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#新增文章分类"><span class="nav-number">4.3.</span> <span class="nav-text">新增文章分类</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#实现步骤-7"><span class="nav-number">4.3.1.</span> <span class="nav-text">实现步骤</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#定义路由和处理函数-3"><span class="nav-number">4.3.2.</span> <span class="nav-text">定义路由和处理函数</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#验证表单数据-3"><span class="nav-number">4.3.3.</span> <span class="nav-text">验证表单数据</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#查询分类名称与别名是否被占用"><span class="nav-number">4.3.4.</span> <span class="nav-text">查询分类名称与别名是否被占用</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#实现新增文章分类的功能"><span class="nav-number">4.3.5.</span> <span class="nav-text">实现新增文章分类的功能</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#根据-Id-删除文章分类"><span class="nav-number">4.4.</span> <span class="nav-text">根据 Id 删除文章分类</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#实现步骤-8"><span class="nav-number">4.4.1.</span> <span class="nav-text">实现步骤</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#定义路由和处理函数-4"><span class="nav-number">4.4.2.</span> <span class="nav-text">定义路由和处理函数</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#验证表单数据-4"><span class="nav-number">4.4.3.</span> <span class="nav-text">验证表单数据</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#实现删除文章分类的功能"><span class="nav-number">4.4.4.</span> <span class="nav-text">实现删除文章分类的功能</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#根据-Id-获取文章分类数据"><span class="nav-number">4.5.</span> <span class="nav-text">根据 Id 获取文章分类数据</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#实现步骤-9"><span class="nav-number">4.5.1.</span> <span class="nav-text">实现步骤</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#定义路由和处理函数-5"><span class="nav-number">4.5.2.</span> <span class="nav-text">定义路由和处理函数</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#验证表单数据-5"><span class="nav-number">4.5.3.</span> <span class="nav-text">验证表单数据</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#实现获取文章分类的功能"><span class="nav-number">4.5.4.</span> <span class="nav-text">实现获取文章分类的功能</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#根据-Id-更新文章分类数据"><span class="nav-number">4.6.</span> <span class="nav-text">根据 Id 更新文章分类数据</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#实现步骤-10"><span class="nav-number">4.6.1.</span> <span class="nav-text">实现步骤</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#定义路由和处理函数-6"><span class="nav-number">4.6.2.</span> <span class="nav-text">定义路由和处理函数</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#验证表单数据-6"><span class="nav-number">4.6.3.</span> <span class="nav-text">验证表单数据</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#查询分类名称与别名是否被占用-1"><span class="nav-number">4.6.4.</span> <span class="nav-text">查询分类名称与别名是否被占用</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#实现更新文章分类的功能"><span class="nav-number">4.6.5.</span> <span class="nav-text">实现更新文章分类的功能</span></a></li></ol></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#文章管理"><span class="nav-number">5.</span> <span class="nav-text">文章管理</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#新建-ev-articles-表"><span class="nav-number">5.1.</span> <span class="nav-text">新建 ev_articles 表</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#发布新文章"><span class="nav-number">5.2.</span> <span class="nav-text">发布新文章</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#实现步骤-11"><span class="nav-number">5.2.1.</span> <span class="nav-text">实现步骤</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#初始化路由模块-2"><span class="nav-number">5.2.2.</span> <span class="nav-text">初始化路由模块</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#初始化路由处理函数模块-2"><span class="nav-number">5.2.3.</span> <span class="nav-text">初始化路由处理函数模块</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#使用-multer-解析表单数据"><span class="nav-number">5.2.4.</span> <span class="nav-text">使用 multer 解析表单数据</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#验证表单数据-7"><span class="nav-number">5.2.5.</span> <span class="nav-text">验证表单数据</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#实现发布文章的功能"><span class="nav-number">5.2.6.</span> <span class="nav-text">实现发布文章的功能</span></a></li></ol></li></ol></li></ol></div>
      </div>
      <!--/noindex-->

      <div class="site-overview-wrap sidebar-panel">
        <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
  <img class="site-author-image" itemprop="image" alt="WayneLee"
    src="/images/avatar.gif">
  <p class="site-author-name" itemprop="name">WayneLee</p>
  <div class="site-description" itemprop="description"></div>
</div>
<div class="site-state-wrap motion-element">
  <nav class="site-state">
      <div class="site-state-item site-state-posts">
          <a href="/archives">
          <span class="site-state-item-count">6</span>
          <span class="site-state-item-name">日志</span>
        </a>
      </div>
      <div class="site-state-item site-state-categories">
            <a href="/categories/">
          
        <span class="site-state-item-count">3</span>
        <span class="site-state-item-name">分类</span></a>
      </div>
  </nav>
</div>
  <div class="feed-link motion-element">
    <a href="/atom.xml" rel="alternate">
      <i class="fa fa-rss"></i>RSS
    </a>
  </div>
  <div class="links-of-author motion-element">
      <span class="links-of-author-item">
        <a href="https://github.com/waynelee7" title="GitHub &amp;rarr; https:&#x2F;&#x2F;github.com&#x2F;waynelee7" rel="noopener" target="_blank"><i class="fa fa-fw fa-github"></i>GitHub</a>
      </span>
      <span class="links-of-author-item">
        <a href="mailto:yourname@gmail.com" title="E-Mail &amp;rarr; mailto:yourname@gmail.com" rel="noopener" target="_blank"><i class="fa fa-fw fa-envelope"></i>E-Mail</a>
      </span>
  </div>



      </div>

    </div>
  </aside>
  <div id="sidebar-dimmer"></div>


      </div>
    </main>

    <footer class="footer">
      <div class="footer-inner">
        

<div class="copyright">
  
  &copy; 
  <span itemprop="copyrightYear">2023</span>
  <span class="with-love">
    <i class="fa fa-user"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">WayneLee</span>
</div>
  <!--<div class="powered-by">由 <a href="https://hexo.io/" class="theme-link" rel="noopener" target="_blank">Hexo</a> 强力驱动 v3.9.0
  </div>
  -->
<!--
  <span class="post-meta-divider">|</span>
-->
  <!-- <div class="theme-info">主题 – <a href="https://pisces.theme-next.org/" class="theme-link" rel="noopener" target="_blank">NexT.Pisces</a> v7.5.0
  </div> 
  -->
<!-- 在网页底部添加网站运行时间 -->
<span id="timeDate">载入天数...</span><span id="times">载入时分秒...</span>
<script>
    var now = new Date();
    function createtime() {
        var grt= new Date("10/11/2018 00:00:00");//
        now.setTime(now.getTime()+250);
        days = (now - grt ) / 1000 / 60 / 60 / 24; dnum = Math.floor(days);
        hours = (now - grt ) / 1000 / 60 / 60 - (24 * dnum); hnum = Math.floor(hours);
        if(String(hnum).length ==1 ){hnum = "0" + hnum;} minutes = (now - grt ) / 1000 /60 - (24 * 60 * dnum) - (60 * hnum);
        mnum = Math.floor(minutes); if(String(mnum).length ==1 ){mnum = "0" + mnum;}
        seconds = (now - grt ) / 1000 - (24 * 60 * 60 * dnum) - (60 * 60 * hnum) - (60 * mnum);
        snum = Math.round(seconds); if(String(snum).length ==1 ){snum = "0" + snum;}
        document.getElementById("timeDate").innerHTML = "网站已运行 "+dnum+" 天 ";
        document.getElementById("times").innerHTML = hnum + " 小时 " + mnum + " 分 " + snum + " 秒";
    }
setInterval("createtime()",250);
</script>


        












        
      </div>
    </footer>
  </div>

  
  <script src="/lib/anime.min.js"></script>
  <script src="/lib/velocity/velocity.min.js"></script>
  <script src="/lib/velocity/velocity.ui.min.js"></script>
<script src="/js/utils.js"></script><script src="/js/motion.js"></script>
<script src="/js/schemes/pisces.js"></script>
<script src="/js/next-boot.js"></script>



  
















  

  

<script src="/live2dw/lib/L2Dwidget.min.js?094cbace49a39548bed64abff5988b05"></script><script>L2Dwidget.init({"model":{"jsonPath":"/live2dw/assets/tororo.model.json"},"display":{"position":"right","width":250,"height":400},"mobile":{"show":true},"log":false,"pluginJsPath":"lib/","pluginModelPath":"assets/","pluginRootPath":"live2dw/","tagMode":false});</script></body>
</html>
